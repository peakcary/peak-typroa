

飞书授权页面开发与调试文档

  项目概述

  本次开发主要针对 /Users/peakom/Documents/work/zai-fe/client/src/pages/feishu/auth.vue
  页面的飞书授权功能进行修复和优化，解决了授权流程中的多个关键问题。

  问题背景

  初始问题

  - 飞书授权页面运行时报错，无法获取 appId
  - 用户反馈：将 appId 写死为 cli_a80e6f280e3b500c
  - 调试信息不完整，难以排查问题

  核心问题分析

  1. appId 获取失败：/api/user/getfsappid 接口调用失败
  2. 权限问题：写死的 appId 对当前用户无权限
  3. 接口调用方式问题：请求方法和参数格式不正确
  4. 调试信息缺失：缺乏详细的调试信息，难以定位问题

  开发思路

  1. 问题定位策略

  - 采用渐进式调试：先解决 appId 问题，再解决权限问题
  - 增加详细的调试信息输出
  - 按照官方文档规范调整接口调用方式

  2. 代码架构优化

  - 将调试信息集成到页面UI中，方便实时查看
  - 采用 fallback 机制：优先使用服务端 appId，失败时使用硬编码 appId
  - 增强错误处理和用户提示

  3. 调试体验改进

  - 在页面上直接显示接口调用状态
  - 提供完整的请求和响应信息
  - 增加远程调试工具的加载状态监控

  详细修改记录

  1. 核心文件修改：client/src/pages/feishu/auth.vue

  1.1 数据结构扩展

  位置：data() 方法中的 debugInfo 对象

  原始状态：
  debugInfo: {
    sdkLoaded: false,
    userAgent: navigator.userAgent,
    currentUrl: window.location.href,
    lastError: '',
    lastResponse: null,
    // ... 其他基础字段
  }

  修改后：
  debugInfo: {
    // 原有字段保持不变
    // 新增接口调用状态字段
    getAppIdStatus: '',           // AppID接口状态：success/error/''
    getAppIdResult: '',           // AppID接口结果描述
    getAppIdResponse: null,       // AppID接口完整响应
    getAppIdRequest: null,        // AppID接口完整请求
    getUserInfoStatus: '',        // 用户信息接口状态
    getUserInfoResult: '',        // 用户信息接口结果描述
    getUserInfoRequest: null      // 用户信息接口完整请求
  }

  1.2 fetchAppId 方法重构

  位置：第528-607行

  核心思路：
  1. 优先调用服务端接口获取 appId
  2. 详细记录调用过程和结果
  3. 失败时使用 fallback appId

  关键修改：
  async fetchAppId() {
    try {
      console.log('=== 开始获取 AppID ===');

      // 更新页面状态
      this.debugInfo.getAppIdResult = '调用中...';
      this.debugInfo.getAppIdStatus = '';
    
      // 记录请求详情
      this.debugInfo.getAppIdRequest = JSON.stringify({
        url: '/api/user/getfsappid',
        method: 'GET',  // 重要：修改为GET请求
        headers: { 'Content-Type': 'application/json' },
        params: null
      }, null, 2);
    
      try {
        const result = await util.request({
          url: '/api/user/getfsappid',
          method: 'GET'  // 关键修改：从POST改为GET
        });
    
        // 保存响应
        this.debugInfo.getAppIdResponse = JSON.stringify(result, null, 2);
    
        if (result && result.errno === 0 && result.data && result.data.appId) {
          // 成功获取服务端appId
          this.debugInfo.getAppIdResult = `成功获取: ${result.data.appId}`;
          this.debugInfo.getAppIdStatus = 'success';
          return result.data.appId;
        } else {
          // 服务端返回但无有效appId
          this.debugInfo.getAppIdResult = `调用成功但无有效appID (errno: ${result?.errno})`;
          this.debugInfo.getAppIdStatus = 'error';
        }
      } catch (apiError) {
        // 接口调用失败
        this.debugInfo.getAppIdResult = `调用失败: ${apiError.message}`;
        this.debugInfo.getAppIdStatus = 'error';
        this.debugInfo.getAppIdResponse = JSON.stringify({ error: apiError.message }, null, 2);
      }
    
      // Fallback机制
      const fallbackAppId = 'cli_a80e6f280e3b500c';
      console.log('服务端获取失败，使用fallback AppId:', fallbackAppId);
      return fallbackAppId;
    
    } catch (error) {
      // 方法级别异常处理
      console.error('fetchAppId失败:', error);
      this.debugInfo.getAppIdResult = `方法异常: ${error.message}`;
      this.debugInfo.getAppIdStatus = 'error';
      throw error;
    }
  }

  1.3 getOpenID 方法优化

  位置：第771-882行

  主要改进：
  1. 记录详细的接口调用信息
  2. 增强错误处理和状态更新
  3. 特殊处理 app_access_token 过期问题

  关键代码段：
  // 保存请求详情用于页面显示
  this.debugInfo.getUserInfoRequest = JSON.stringify({
    url: apiRequest.url,
    method: apiRequest.method,
    headers: { 'Content-Type': 'application/json' },
    body: apiRequest.data
  }, null, 2);

  // 错误处理增强
  if (!result || result.errno !== 0) {
    // 更新页面状态
    this.debugInfo.getUserInfoResult = `失败 (errno: ${result?.errno}): ${errorMsg}`;
    this.debugInfo.getUserInfoStatus = 'error';

    // 特殊处理token过期错误
    if (result?.errno === 130356) {
      this.debugInfo.getUserInfoResult = 'app_access_token过期，需要服务端刷新';
      // 详细的解决建议输出到console
    }
    
    throw new Error(errorMsg);
  }

  // 成功处理
  this.openID = result.data.openID;
  this.debugInfo.getUserInfoResult = `成功获取openID: ${this.openID}`;
  this.debugInfo.getUserInfoStatus = 'success';

  1.4 callFeishuAuthAPI 方法规范化

  位置：第634-693行

  按官方文档重构：
  async callFeishuAuthAPI(appId) {
    return new Promise((resolve, reject) => {
      try {
        // 检查h5sdk是否存在
        if (!window.h5sdk) {
          const error = 'h5sdk不存在，请在飞书客户端中打开';
          reject(new Error(error));
          return;
        }

        // 按官方文档：先设置error回调
        window.h5sdk.error(err => {
          console.error('h5sdk error:', JSON.stringify(err));
          reject(new Error('h5sdk error: ' + JSON.stringify(err)));
        });
    
        // 按官方文档：ready后调用API
        window.h5sdk.ready(() => {
          // 获取用户信息用于调试
          if (window.tt && window.tt.getSystemInfoSync) {
            try {
              const systemInfo = window.tt.getSystemInfoSync();
              console.log('系统信息:', systemInfo);
            } catch (e) {
              console.log('getSystemInfoSync失败:', e);
            }
          }
    
          // 调用JSAPI tt.requestAccess 获取 authorization code
          window.tt.requestAccess({
            appID: appId,
            scopeList: [],
            success: (res) => {
              console.log('getAuthCode succeed');
              console.log('authorization code 存储在 res.code:', res.code);
              this.handleAuthSuccess(res, resolve, reject);
            },
            fail: (err) => {
              console.log('getAuthCode failed, err:', JSON.stringify(err));
    
              // 特殊处理权限错误
              if (err.errno === 2700002 && err.errString && err.errString.includes('20010')) {
                console.log('=== 权限错误分析 ===');
                console.log('错误类型: 当前用户无该应用权限');
                console.log('建议解决方案: 联系应用管理员，将当前用户添加为测试用户');
                this.logAppPermissionInfo(appId);
              }
    
              this.handleAuthFailure(err, reject);
            },
            cancel: () => {
              console.log('用户取消授权');
              this.handleAuthCancel(reject);
            }
          });
        });
      } catch (error) {
        reject(new Error('SDK初始化失败: ' + error.message));
      }
    });
  }

  1.5 UI调试信息扩展

  位置：第162-192行

  新增调试信息显示：
  <!-- AppID接口详情 -->
  <div class="debug-item">
    <span class="debug-label">AppID接口:</span>
    <span class="debug-value" :class="debugInfo.getAppIdStatus">
      {{ debugInfo.getAppIdResult || '未调用' }}
    </span>
  </div>
  <div class="debug-item" v-if="debugInfo.getAppIdRequest">
    <span class="debug-label">AppID请求:</span>
    <div class="debug-response">{{ debugInfo.getAppIdRequest }}</div>
  </div>
  <div class="debug-item" v-if="debugInfo.getAppIdResponse">
    <span class="debug-label">AppID响应:</span>
    <div class="debug-response">{{ debugInfo.getAppIdResponse }}</div>
  </div>

  <!-- 用户信息接口详情 -->
  <div class="debug-item">
    <span class="debug-label">用户信息接口:</span>
    <span class="debug-value" :class="debugInfo.getUserInfoStatus">
      {{ debugInfo.getUserInfoResult || '未调用' }}
    </span>
  </div>
  <div class="debug-item" v-if="debugInfo.getUserInfoRequest">
    <span class="debug-label">用户信息请求:</span>
    <div class="debug-response">{{ debugInfo.getUserInfoRequest }}</div>
  </div>
  <div class="debug-item" v-if="debugInfo.lastResponse">
    <span class="debug-label">用户信息响应:</span>
    <div class="debug-response">{{ debugInfo.lastResponse }}</div>
  </div>

  2. HTML文件优化：client/index.html

  2.1 远程调试工具增强

  位置：第9-13行

  修改内容：
  <!-- 原始代码 -->
  <script src='https://lf-package-cn.feishucdn.com/obj/feishu-static/op/fe/devtools_frontend/remote-debug-0.0.1-a
  lpha.6.js'></script>

  <!-- 增强后 -->
  <script
    src='https://lf-package-cn.feishucdn.com/obj/feishu-static/op/fe/devtools_frontend/remote-debug-0.0.1-alpha.6
  .js'
    onload="console.log('✅ 飞书远程调试工具加载成功'); window.FEISHU_REMOTE_DEBUG_LOADED = true;"
    onerror="console.error('❌ 飞书远程调试工具加载失败'); window.FEISHU_REMOTE_DEBUG_LOADED = false;"
  ></script>

  目的：
  - 监控远程调试工具的加载状态
  - 在console中提供明确的成功/失败反馈
  - 设置全局变量标记加载状态

  2.2 SDK状态检测增强

  位置：第66-81行

  新增检测项：
  function checkSDKStatus() {
    const status = {
      // 原有检测项
      hasWindow: typeof window !== 'undefined',
      hasH5sdk: !!window.h5sdk,
      hasTt: !!window.tt,
      hasRequestAccess: !!(window.tt && window.tt.requestAccess),

      // 新增远程调试工具检测
      hasRemoteDebug: !!window.FeishuRemoteDebug,
      remoteDebugLoaded: window.FEISHU_REMOTE_DEBUG_LOADED,
      remoteDebugKeys: window.FeishuRemoteDebug ? Object.keys(window.FeishuRemoteDebug) : []
    };
    console.log('SDK状态检查:', status);
    return status;
  }

  接口规范确认

  1. /api/user/getfsappid 接口

  GET /api/user/getfsappid
  Content-Type: application/json

  # 无需参数

  # 成功响应
  {
    "errno": 0,
    "data": {
      "appId": "cli_xxx"
    }
  }

  2. /api/isv/feishu/getuserinfo 接口

  POST /api/isv/feishu/getuserinfo
  Content-Type: application/json

  {
    "code": "授权码"
  }

  # 成功响应
  {
    "errno": 0,
    "data": {
      "openID": "ou_xxx",
      "unionID": "on_xxx",
      "avatarUrl": "https://...",
      "name": "用户名",
      "en_name": "English Name"
    }
  }

  # 常见错误
  {
    "errno": 130356,
    "msg": "权限飞朽期应用limit app_access_token失效"
  }

  问题解决进展

  ✅ 已解决的问题

  1. appId硬编码问题：实现了服务端获取+fallback机制
  2. 接口调用方式错误：修正了GET/POST请求方法
  3. 调试信息缺失：完善了页面和console调试信息
  4. 权限错误定位：增加了详细的权限问题分析和解决建议
  5. SDK加载检测：完善了飞书SDK和远程调试工具的加载检测

  ⚠️ 待解决的问题

  1. app_access_token过期：需要后端刷新token
  2. 应用权限配置：需要在飞书开发者后台配置用户权限
  3. 网络环境限制：某些环境可能无法加载远程调试工具

  📋 已确认的技术要点

  1. 飞书授权流程正常：可以成功获取到授权码
  2. 前端逻辑完整：各个环节的错误处理和状态管理完善
  3. 调试体验良好：页面提供完整的调试信息显示

  继续开发指南

  1. 环境准备

  # 项目目录
  cd /Users/peakom/Documents/work/zai-fe

  # 关键文件路径
  client/src/pages/feishu/auth.vue      # 主要业务逻辑文件
  client/index.html                     # SDK加载和调试工具配置

  2. 调试方法

  1. 页面调试信息：访问页面后查看错误面板中的详细调试信息
  2. Console日志：查看浏览器console中的详细日志输出
  3. 网络面板：查看接口调用的实际请求和响应

  3. 常见问题排查步骤

  1. SDK加载问题：检查console中SDK加载状态
  2. 接口调用问题：查看页面调试信息中的请求和响应详情
  3. 权限问题：根据错误码查找对应的解决方案
  4. Token问题：联系后端刷新app_access_token

  4. 代码维护要点

  1. 保持调试信息完整：任何接口调用都应该记录详细信息
  2. 错误处理规范：使用统一的错误处理和状态更新模式
  3. Console日志规范：使用带前缀的日志便于过滤查看
  4. 状态管理一致性：确保页面状态与实际调用状态同步

  技术栈说明

  - Vue 2.x：主要框架
  - Element UI：UI组件库
  - 飞书SDK：h5-js-sdk-1.5.42.js
  - 远程调试工具：remote-debug-0.0.1-alpha.6.js

  部署注意事项

  1. 确保网络访问：飞书CDN资源可正常访问
  2. HTTPS环境：飞书SDK需要HTTPS环境
  3. 域名白名单：确保域名在飞书应用配置中
  4. 跨域配置：确保后端接口支持跨域访问

---
  文档版本：v1.0最后更新：2025-08-26适用环境：开发/测试环境调试