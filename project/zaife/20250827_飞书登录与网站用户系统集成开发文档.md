é£ä¹¦ç™»å½•ä¸ç½‘ç«™ç”¨æˆ·ç³»ç»Ÿé›†æˆå¼€å‘æ–‡æ¡£

  é¡¹ç›®æ¦‚è¿°

  æœ¬é¡¹ç›®å®ç°äº†é£ä¹¦OAuthæˆæƒç™»å½•ä¸ç½‘ç«™ç°æœ‰ç”¨æˆ·ç³»ç»Ÿçš„æ·±åº¦é›†æˆï¼Œæ”¯æŒæ–°ç”¨æˆ·è‡ªåŠ¨æ³¨å†Œç»‘å®šå’Œè€ç”¨æˆ·ç›´æ¥ç™»å½•çš„å®Œæ•´ä¸šåŠ¡æµç¨‹
  ã€‚

  æŠ€æœ¯æ¶æ„

  å‰ç«¯æŠ€æœ¯æ ˆ

  - Vue 2.x - ä¸»æ¡†æ¶
  - Element UI - UIç»„ä»¶åº“
  - é£ä¹¦h5-js-sdk-1.5.42 - é£ä¹¦å®˜æ–¹SDK
  - é£ä¹¦è¿œç¨‹è°ƒè¯•å·¥å…· - remote-debug-0.0.1-alpha.6

  æ ¸å¿ƒæ–‡ä»¶ç»“æ„

  /Users/peakom/Documents/work/zai-fe/
  â”œâ”€â”€ client/
  â”‚   â”œâ”€â”€ index.html                    # SDKåŠ è½½å’Œè¿œç¨‹è°ƒè¯•é…ç½®
  â”‚   â””â”€â”€ src/pages/feishu/auth.vue     # ä¸»ä¸šåŠ¡é€»è¾‘æ–‡ä»¶
  â””â”€â”€ ç›¸å…³é…ç½®æ–‡ä»¶

  ä¸šåŠ¡æµç¨‹è®¾è®¡

  æ•´ä½“ç”¨æˆ·ä½“éªŒæµç¨‹

  graph TD
      A[ç”¨æˆ·ç‚¹å‡»é£ä¹¦ç™»å½•] --> B[é£ä¹¦OAuthæˆæƒ]
      B --> C[è·å–authorization code]
      C --> D[æ¢å–ç”¨æˆ·OpenID]
      D --> E[å°è¯•ç™»å½•]
      E --> F{ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œ}
      F -->|æ˜¯| G[ç›´æ¥ç™»å½•æˆåŠŸ]
      F -->|å¦| H[æ˜¾ç¤ºæ‰‹æœºå·ç»‘å®šç•Œé¢]
      H --> I[ç”¨æˆ·è¾“å…¥æ‰‹æœºå·]
      I --> J[å‘é€çŸ­ä¿¡éªŒè¯ç ]
      J --> K[ç”¨æˆ·è¾“å…¥éªŒè¯ç ]
      K --> L[å¯é€‰è¾“å…¥é‚€è¯·ç ]
      L --> M[æäº¤ç»‘å®šä¿¡æ¯]
      M --> N[ç»‘å®šæˆåŠŸå¹¶ç™»å½•]
      G --> O[è·³è½¬åˆ°ç›®æ ‡é¡µé¢]
      N --> O

  çŠ¶æ€æœºè®¾è®¡

  const AUTH_STATES = {
    LOADING: 'loading',        // SDKåŠ è½½ä¸­
    CHECKING: 'checking',      // æ£€æŸ¥ç™»å½•çŠ¶æ€
    NEED_BINDING: 'needBinding', // éœ€è¦ç»‘å®šæ‰‹æœºå·
    BINDING: 'binding',        // ç»‘å®šä¸­
    SUCCESS: 'success',        // ç™»å½•æˆåŠŸ
    ERROR: 'error'            // å‡ºç°é”™è¯¯
  };

  æ¥å£è®¾è®¡è§„èŒƒ

  1. è·å–AppIDæ¥å£

  GET /api/user/getfsappid

  å“åº”æ ¼å¼:
  {
    "errno": 0,
    "data": {
      "appId": "cli_a80e6f280e3b500c"
    }
  }

  è¯´æ˜:
  - å®‰å…¨è€ƒè™‘ï¼ŒAppIDä¸åœ¨å‰ç«¯ç¡¬ç¼–ç 
  - å‰ç«¯ä¼˜å…ˆä½¿ç”¨æœåŠ¡ç«¯è¿”å›çš„AppID
  - å¤±è´¥æ—¶ä½¿ç”¨fallbackæœºåˆ¶

  2. è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£

  POST /api/isv/feishu/getuserinfo
  Content-Type: application/json

  {
    "code": "é£ä¹¦æˆæƒç "
  }

  æˆåŠŸå“åº”:
  {
    "errno": 0,
    "data": {
      "openID": "ou_29bfeae5cea25e534f3ce2b1c3067add",
      "unionID": "on_xxx",
      "avatarUrl": "https://...",
      "name": "ç”¨æˆ·å",
      "en_name": "English Name"
    }
  }

  å¸¸è§é”™è¯¯:
  {
    "errno": 130356,
    "msg": "æƒé™é£æœ½æœŸåº”ç”¨limit app_access_tokenå¤±æ•ˆ"
  }

  3. ç™»å½•/ç»‘å®šç»Ÿä¸€æ¥å£

  POST /api/user/fsreglogin
  Content-Type: application/json

  åœºæ™¯1: å·²æ³¨å†Œç”¨æˆ·ç›´æ¥ç™»å½•
  // è¯·æ±‚
  {
    "openID": "ou_29bfeae5cea25e534f3ce2b1c3067add"
  }

  // æˆåŠŸå“åº”
  {
    "errno": 0,
    "data": {
      "token": "jwt_token_here",
      "userInfo": {
        "userId": "123",
        "name": "ç”¨æˆ·å",
        "avatar": "å¤´åƒURL"
      }
    }
  }

  åœºæ™¯2: æ–°ç”¨æˆ·éœ€è¦ç»‘å®š
  // è¯·æ±‚ (åŒåœºæ™¯1)
  {
    "openID": "ou_29bfeae5cea25e534f3ce2b1c3067add"
  }

  // éœ€è¦ç»‘å®šå“åº”
  {
    "errno": 3001,
    "msg": "ç”¨æˆ·ä¸å­˜åœ¨ï¼Œéœ€è¦ç»‘å®šæ‰‹æœºå·"
  }

  åœºæ™¯3: ç»‘å®šæ‰‹æœºå·æ³¨å†Œ
  // è¯·æ±‚
  {
    "openID": "ou_29bfeae5cea25e534f3ce2b1c3067add",
    "isBinding": 1,
    "mobile": "13800138000",
    "code": "123456",
    "referrerPin": "é‚€è¯·ç (å¯é€‰)"
  }

  // æˆåŠŸå“åº” (åŒåœºæ™¯1)
  {
    "errno": 0,
    "data": {
      "token": "jwt_token_here",
      "userInfo": {...}
    }
  }

  4. å‘é€çŸ­ä¿¡éªŒè¯ç æ¥å£

  POST /api/user/getreglogincode
  Content-Type: application/json

  {
    "mobile": "13800138000"
  }

  æˆåŠŸå“åº”:
  {
    "errno": 0,
    "msg": "éªŒè¯ç å·²å‘é€"
  }

  å‰ç«¯å®ç°è¯¦è§£

  æ ¸å¿ƒç»„ä»¶ç»“æ„

  1. æ•°æ®ç»“æ„è®¾è®¡

  data() {
    return {
      // è®¤è¯çŠ¶æ€
      authState: AUTH_STATES.LOADING,

      // é£ä¹¦ç›¸å…³æ•°æ®
      openID: '',
      code: '', // é£ä¹¦æˆæƒç 
    
      // ç»‘å®šè¡¨å•
      bindingForm: {
        mobile: '',
        code: '',
        referrerPin: ''
      },
    
      // UIçŠ¶æ€
      hasReferrerPin: false,
      agreement: true,
      isSendingCode: false,
      countdown: 60,
    
      // è°ƒè¯•ä¿¡æ¯ - å…³é”®ç‰¹æ€§
      debugInfo: {
        // SDKçŠ¶æ€
        sdkLoaded: false,
        hasTt: false,
        hasH5sdk: false,
        hasRemoteDebug: false,
    
        // æ¥å£è°ƒç”¨çŠ¶æ€
        getAppIdStatus: '',      // success/error/''
        getAppIdResult: '',      // ç»“æœæè¿°
        getAppIdResponse: null,  // å®Œæ•´å“åº”JSON
        getAppIdRequest: null,   // å®Œæ•´è¯·æ±‚JSON
    
        getUserInfoStatus: '',
        getUserInfoResult: '',
        getUserInfoRequest: null,
    
        // é”™è¯¯ä¿¡æ¯
        lastError: '',
        lastResponse: null
      }
    };
  }

  2. å…³é”®æ–¹æ³•å®ç°

  SDKåˆå§‹åŒ–å’Œæ£€æµ‹:
  async waitForFeishuSDK() {
    return new Promise((resolve, reject) => {
      let retryCount = 0;
      const checkSDK = () => {
        if (window.h5sdk && window.tt && window.tt.requestAccess) {
          resolve();
        } else if (retryCount < 100) {
          retryCount++;
          setTimeout(checkSDK, 100);
        } else {
          reject(new Error('é£ä¹¦SDKåŠ è½½è¶…æ—¶'));
        }
      };
      checkSDK();
    });
  }

  è·å–AppID (æ”¯æŒfallback):
  async fetchAppId() {
    try {
      // ä¼˜å…ˆä»æœåŠ¡ç«¯è·å–
      const result = await util.request({
        url: '/api/user/getfsappid',
        method: 'GET'
      });

      if (result?.errno === 0 && result.data?.appId) {
        return result.data.appId;
      }
    } catch (error) {
      console.error('æœåŠ¡ç«¯è·å–AppIDå¤±è´¥:', error);
    }
    
    // fallbackåˆ°ç¡¬ç¼–ç 
    return 'cli_a80e6f280e3b500c';
  }

  é£ä¹¦æˆæƒæ ¸å¿ƒé€»è¾‘:
  async callFeishuAuthAPI(appId) {
    return new Promise((resolve, reject) => {
      // æ£€æŸ¥ç¯å¢ƒå’ŒSDK
      if (!window.h5sdk) {
        reject(new Error('è¯·åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­æ‰“å¼€'));
        return;
      }

      // æŒ‰å®˜æ–¹æ–‡æ¡£è®¾ç½®é”™è¯¯å›è°ƒ
      window.h5sdk.error(err => {
        reject(new Error('h5sdk error: ' + JSON.stringify(err)));
      });
    
      // SDKå°±ç»ªåè°ƒç”¨æˆæƒ
      window.h5sdk.ready(() => {
        window.tt.requestAccess({
          appID: appId,
          scopeList: [],
          success: (res) => {
            this.code = res.code;
            resolve(res.code);
          },
          fail: (err) => {
            // ç‰¹æ®Šå¤„ç†æƒé™é”™è¯¯
            if (err.errno === 2700002 && err.errString?.includes('20010')) {
              this.logAppPermissionInfo(appId);
            }
            reject(new Error(err.errString || 'æˆæƒå¤±è´¥'));
          }
        });
      });
    });
  }

  ç»Ÿä¸€ç™»å½•å¤„ç†:
  async attemptLogin() {
    try {
      const result = await util.request({
        url: '/api/user/fsreglogin',
        method: 'POST',
        data: { openID: this.openID }
      });

      if (result.errno === 0) {
        // ç™»å½•æˆåŠŸ - ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        this.saveUserSession(result.data);
        this.handleSuccess();
      } else if (result.errno === 3001) {
        // éœ€è¦ç»‘å®šæ‰‹æœºå·
        this.authState = AUTH_STATES.NEED_BINDING;
      } else {
        // å…¶ä»–é”™è¯¯
        const errorInfo = getErrorInfo(result.errno);
        this.handleError(errorInfo.title, errorInfo.message);
      }
    } catch (error) {
      this.handleError('ç™»å½•å¤±è´¥', error.message);
    }
  }

  æ‰‹æœºå·ç»‘å®šå¤„ç†:
  async handleBinding() {
    if (!this.agreement) {
      util.message('warning', 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®');
      return;
    }

    await this.$refs.bindingForm.validate();
    this.authState = AUTH_STATES.BINDING;
    
    const result = await util.request({
      url: '/api/user/fsreglogin',
      method: 'POST',
      data: {
        openID: this.openID,
        isBinding: 1,
        mobile: this.bindingForm.mobile,
        code: this.bindingForm.code,
        referrerPin: this.bindingForm.referrerPin
      }
    });
    
    if (result.errno === 0) {
      util.message('success', 'ç»‘å®šæˆåŠŸï¼');
      this.saveUserSession(result.data);
      this.handleSuccess();
    } else {
      this.authState = AUTH_STATES.NEED_BINDING;
      util.message('error', result.msg || 'ç»‘å®šå¤±è´¥');
    }
  }

  3. UIç•Œé¢è®¾è®¡

  ä¸»è¦çŠ¶æ€ç•Œé¢

  åŠ è½½çŠ¶æ€:
  <div v-if="authState === 'loading'" class="loading-panel">
    <div class="spinner">...</div>
    <div class="loading-text">{{ loadingText }}</div>
  </div>

  ç»‘å®šæ‰‹æœºå·ç•Œé¢:
  <div v-else-if="authState === 'needBinding'" class="binding-panel">
    <el-form :model="bindingForm" :rules="bindingRules">
      <!-- æ‰‹æœºå·è¾“å…¥ -->
      <el-form-item prop="mobile">
        <el-input placeholder="è¯·è¾“å…¥æ‰‹æœºå·" v-model="bindingForm.mobile"/>
      </el-form-item>

      <!-- éªŒè¯ç è¾“å…¥ -->
      <el-form-item prop="code">
        <el-input placeholder="è¯·è¾“å…¥éªŒè¯ç " v-model="bindingForm.code">
          <template #append>
            <el-button
              :disabled="isSendingCode"
              @click="sendVerificationCode"
            >
              {{ isSendingCode ? `${countdown}s` : 'å‘é€éªŒè¯ç ' }}
            </el-button>
          </template>
        </el-input>
      </el-form-item>
    
      <!-- é‚€è¯·ç (å¯é€‰) -->
      <el-form-item prop="referrerPin">
        <el-checkbox v-model="hasReferrerPin">ä½¿ç”¨é‚€è¯·ç </el-checkbox>
        <el-input
          v-if="hasReferrerPin"
          placeholder="è¯·è¾“å…¥é‚€è¯·ç "
          v-model="bindingForm.referrerPin"
        />
      </el-form-item>
    
      <!-- ç”¨æˆ·åè®® -->
      <el-checkbox v-model="agreement">
        æˆ‘å·²é˜…è¯»å¹¶åŒæ„
        <a href="/info/agreement" target="_blank">ã€Šç”¨æˆ·åè®®ã€‹</a>
        <a href="/info/privacy" target="_blank">ã€Šéšç§æ”¿ç­–ã€‹</a>
      </el-checkbox>
    
      <!-- æäº¤æŒ‰é’® -->
      <el-button
        type="primary"
        :loading="authState === 'binding'"
        @click="handleBinding"
      >
        {{ authState === 'binding' ? 'ç»‘å®šä¸­...' : 'ç«‹å³ç»‘å®š' }}
      </el-button>
    </el-form>
  </div>

  è°ƒè¯•ä¿¡æ¯ç•Œé¢ (å¼€å‘é‡è¦ç‰¹æ€§):
  <div class="debug-info">
    <!-- SDKçŠ¶æ€ -->
    <div class="debug-item">
      <span class="debug-label">SDKçŠ¶æ€:</span>
      <span class="debug-value" :class="debugInfo.sdkLoaded ? 'success' : 'error'">
        {{ debugInfo.sdkLoaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½' }}
      </span>
    </div>

    <!-- æ¥å£è°ƒç”¨è¯¦æƒ… -->
    <div class="debug-item">
      <span class="debug-label">AppIDæ¥å£:</span>
      <span class="debug-value" :class="debugInfo.getAppIdStatus">
        {{ debugInfo.getAppIdResult || 'æœªè°ƒç”¨' }}
      </span>
    </div>
    
    <!-- å®Œæ•´çš„è¯·æ±‚å“åº”ä¿¡æ¯ -->
    <div class="debug-item" v-if="debugInfo.getAppIdRequest">
      <span class="debug-label">AppIDè¯·æ±‚:</span>
      <div class="debug-response">{{ debugInfo.getAppIdRequest }}</div>
    </div>
    
    <div class="debug-item" v-if="debugInfo.getAppIdResponse">
      <span class="debug-label">AppIDå“åº”:</span>
      <div class="debug-response">{{ debugInfo.getAppIdResponse }}</div>
    </div>
  </div>

  4. SDKé…ç½® (client/index.html)

  å¤šCDNåŠ è½½ç­–ç•¥:
  <script>
  (function() {
    const SDK_URLS = [
      'https://lf1-cdn-tos.bytegoofy.com/goofy/lark/op/h5-js-sdk-1.5.42.js',
      'https://sf1-scmcdn-tos.pstatp.com/goofy/lark/op/h5-js-sdk-1.5.42.js',
      'https://lf3-cdn-tos.bytescm.com/goofy/lark/op/h5-js-sdk-1.5.42.js'
    ];

    function loadSDK(urls, index = 0) {
      if (index >= urls.length) return;
    
      const script = document.createElement('script');
      script.src = urls[index];
      script.onload = () => console.log('SDKåŠ è½½æˆåŠŸ:', urls[index]);
      script.onerror = () => loadSDK(urls, index + 1);
      document.head.appendChild(script);
    }
    
    loadSDK(SDK_URLS);
  })();
  </script>

  è¿œç¨‹è°ƒè¯•å·¥å…·:
  <script
    src='https://lf-package-cn.feishucdn.com/obj/feishu-static/op/fe/devtools_frontend/remote-debug-0.0.1-alpha.6
  .js'
    onload="console.log('âœ… è¿œç¨‹è°ƒè¯•å·¥å…·åŠ è½½æˆåŠŸ'); window.FEISHU_REMOTE_DEBUG_LOADED = true;"
    onerror="console.error('âŒ è¿œç¨‹è°ƒè¯•å·¥å…·åŠ è½½å¤±è´¥'); window.FEISHU_REMOTE_DEBUG_LOADED = false;"
  ></script>

  è°ƒè¯•å’Œæ’é”™æœºåˆ¶

  1. åˆ†å±‚è°ƒè¯•ä¿¡æ¯

  Consoleæ—¥å¿—åˆ†ç±»:
  // SDKæ£€æµ‹æ—¥å¿—
  console.log('=== å¼€å§‹æ£€æµ‹é£ä¹¦SDK ===');
  console.log('SDKçŠ¶æ€æ£€æŸ¥:', status);

  // æ¥å£è°ƒç”¨æ—¥å¿—
  console.log('=== AppIDæ¥å£è°ƒç”¨ ===');
  console.log('è¯·æ±‚:', request);
  console.log('å“åº”:', response);

  // æƒé™é”™è¯¯åˆ†æ
  console.log('=== æƒé™é”™è¯¯åˆ†æ ===');
  console.log('é”™è¯¯ç±»å‹: å½“å‰ç”¨æˆ·æ— è¯¥åº”ç”¨æƒé™');
  console.log('å»ºè®®è§£å†³æ–¹æ¡ˆ: è”ç³»ç®¡ç†å‘˜æ·»åŠ æµ‹è¯•ç”¨æˆ·');

  é¡µé¢è°ƒè¯•é¢æ¿:
  - å®æ—¶æ˜¾ç¤ºSDKåŠ è½½çŠ¶æ€
  - å®Œæ•´çš„æ¥å£è¯·æ±‚å’Œå“åº”ä¿¡æ¯
  - é”™è¯¯è¯¦æƒ…å’Œè§£å†³å»ºè®®
  - ç”¨æˆ·èº«ä»½å’Œæƒé™ä¿¡æ¯

  2. å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

| é—®é¢˜ç±»å‹    | é”™è¯¯ä¿¡æ¯       | åŸå› åˆ†æ             | è§£å†³æ–¹æ¡ˆ               |
| ----------- | -------------- | -------------------- | ---------------------- |
| SDKåŠ è½½å¤±è´¥ | h5sdkæœªåŠ è½½    | ç½‘ç»œé—®é¢˜/CDNè®¿é—®å¤±è´¥ | å¤šCDNé‡è¯•æœºåˆ¶          |
| æƒé™é”™è¯¯    | errno: 2700002 | ç”¨æˆ·æ— åº”ç”¨æƒé™       | æ·»åŠ æµ‹è¯•ç”¨æˆ·åˆ°é£ä¹¦åå° |
| Tokenè¿‡æœŸ   | errno: 130356  | app_access_tokenè¿‡æœŸ | åç«¯åˆ·æ–°token          |
| ç»‘å®šå¤±è´¥    | errno: å…¶ä»–    | æ‰‹æœºå·/éªŒè¯ç é”™è¯¯    | æ£€æŸ¥è¾“å…¥ä¿¡æ¯           |

  3. æ€§èƒ½ç›‘æ§

  // å…³é”®èŠ‚ç‚¹æ€§èƒ½ç›‘æ§
  perfMonitor.mark('auth_start');
  perfMonitor.mark('sdk_ready');
  perfMonitor.mark('auth_success');

  // è®¡ç®—è€—æ—¶
  perfMonitor.measure('total_auth_time', 'auth_start', 'auth_success');

  éƒ¨ç½²å’Œé…ç½®

  1. é£ä¹¦å¼€å‘è€…åå°é…ç½®

  å¿…éœ€é…ç½®é¡¹:
  - åº”ç”¨ID: cli_a80e6f280e3b500c
  - é‡å®šå‘URI: http://local.zizai.work:8058/feishu/auth
  - æƒé™èŒƒå›´: è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  - æµ‹è¯•ç”¨æˆ·: æ·»åŠ å¼€å‘æµ‹è¯•è´¦å·

  å¯è§èŒƒå›´è®¾ç½®:
  - ä¼ä¸šå†…éƒ¨åº”ç”¨ï¼šé…ç½®å¯è§éƒ¨é—¨/ç”¨æˆ·
  - åº”ç”¨å•†åº—åº”ç”¨ï¼šé…ç½®å‘å¸ƒèŒƒå›´

  2. æœåŠ¡ç«¯è¦æ±‚

  æ¥å£å®ç°æ¸…å•:
  - GET /api/user/getfsappid - è¿”å›åº”ç”¨ID
  - POST /api/isv/feishu/getuserinfo - è·å–ç”¨æˆ·ä¿¡æ¯
  - POST /api/user/fsreglogin - ç™»å½•/ç»‘å®šç»Ÿä¸€æ¥å£
  - POST /api/user/getreglogincode - å‘é€çŸ­ä¿¡éªŒè¯ç 

  å®‰å…¨è¦æ±‚:
  - app_access_tokenå®šæœŸåˆ·æ–°æœºåˆ¶
  - çŸ­ä¿¡éªŒè¯ç é˜²åˆ·æœºåˆ¶
  - ç”¨æˆ·æ•°æ®åŠ å¯†å­˜å‚¨

  3. ç¯å¢ƒè¦æ±‚

  è¿è¡Œç¯å¢ƒ:
  - HTTPSåè®® (é£ä¹¦SDKè¦æ±‚)
  - åŸŸååœ¨é£ä¹¦åº”ç”¨ç™½åå•ä¸­
  - æ”¯æŒè·¨åŸŸè¯·æ±‚çš„åç«¯é…ç½®

  ç”¨æˆ·ä½“éªŒä¼˜åŒ–

  1. åŠ è½½ä½“éªŒ

  // æ¸è¿›å¼åŠ è½½æç¤º
  const loadingMessages = [
    'æ­£åœ¨éªŒè¯èº«ä»½...',
    'è·å–æˆæƒç ...',
    'è·å–ç”¨æˆ·ä¿¡æ¯...',
    'æ­£åœ¨ç™»å½•...'
  ];

  // æ ¹æ®å½“å‰æ­¥éª¤æ˜¾ç¤ºå¯¹åº”æç¤º
  this.loadingText = loadingMessages[currentStep];

  2. é”™è¯¯å‹å¥½æç¤º

  // ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯æ˜ å°„
  const ERROR_MESSAGES = {
    130356: {
      title: 'Tokenè¿‡æœŸ',
      message: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•',
      action: 'è”ç³»æŠ€æœ¯æ”¯æŒåˆ·æ–°token'
    },
    2700002: {
      title: 'æƒé™ä¸è¶³',
      message: 'å½“å‰è´¦å·æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½',
      action: 'è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™'
    }
  };

  3. å“åº”å¼é€‚é…

  // ç§»åŠ¨ç«¯é€‚é…
  @media (max-width: 768px) {
    .binding-panel {
      padding: 30px 20px;
      margin: 10px;
    }

    .debug-info {
      font-size: 12px;
      .debug-item {
        flex-direction: column;
      }
    }
  }

  æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†

  1. å…¨å±€çŠ¶æ€

  // ç™»å½•æˆåŠŸåè®¾ç½®å…¨å±€ç”¨æˆ·çŠ¶æ€
  window.ZAI = window.ZAI || {};
  window.ZAI.user = {
    isLogin: true,
    userId: userData.userId,
    name: userData.name,
    avatar: userData.avatar,
    openID: this.openID // ä¿å­˜é£ä¹¦OpenIDç”¨äºåç»­æ¥å£è°ƒç”¨
  };

  2. æœ¬åœ°å­˜å‚¨ç­–ç•¥

  // Tokenå­˜å‚¨
  localStorage.setItem('auth_token', userData.token);
  localStorage.setItem('user_info', JSON.stringify(userData.userInfo));

  // é£ä¹¦ç›¸å…³ä¿¡æ¯å­˜å‚¨
  sessionStorage.setItem('feishu_openid', this.openID);
  sessionStorage.setItem('feishu_auth_time', Date.now());

  3. é¡µé¢è·³è½¬é€»è¾‘

  handleSuccess() {
    this.authState = AUTH_STATES.SUCCESS;

    // 1ç§’åè·³è½¬ï¼Œç»™ç”¨æˆ·æˆåŠŸåé¦ˆæ—¶é—´
    setTimeout(() => {
      const redirectUrl = this.redirectUrl || '/dashboard';
      window.location.href = redirectUrl;
    }, 1000);
  }

  æµ‹è¯•å’ŒéªŒè¯

  1. åŠŸèƒ½æµ‹è¯•æ¸…å•

  åŸºç¡€åŠŸèƒ½:
  - SDKæ­£å¸¸åŠ è½½
  - è·å–AppIDæˆåŠŸ
  - é£ä¹¦æˆæƒæˆåŠŸè·å–code
  - codeæ¢å–OpenIDæˆåŠŸ

  ç”¨æˆ·åœºæ™¯:
  - å·²æ³¨å†Œç”¨æˆ·ç›´æ¥ç™»å½•
  - æ–°ç”¨æˆ·æ˜¾ç¤ºç»‘å®šç•Œé¢
  - æ‰‹æœºå·éªŒè¯ç å‘é€æˆåŠŸ
  - ç»‘å®šæˆåŠŸå¹¶ç™»å½•
  - é”™è¯¯æƒ…å†µæ­£ç¡®æ˜¾ç¤º

  è¾¹ç•Œæƒ…å†µ:
  - ç½‘ç»œå¼‚å¸¸å¤„ç†
  - æƒé™ä¸è¶³å¤„ç†
  - Tokenè¿‡æœŸå¤„ç†
  - ç”¨æˆ·å–æ¶ˆæˆæƒå¤„ç†

  2. è°ƒè¯•éªŒè¯æ–¹æ³•

  å¼€å‘è€…å·¥å…·æ£€æŸ¥:
  // æ£€æŸ¥SDKåŠ è½½çŠ¶æ€
  console.log('SDKçŠ¶æ€:', {
    hasH5sdk: !!window.h5sdk,
    hasTt: !!window.tt,
    hasRequestAccess: !!(window.tt && window.tt.requestAccess)
  });

  // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
  console.log('ç”¨æˆ·çŠ¶æ€:', window.ZAI?.user);

  // æ£€æŸ¥å­˜å‚¨çŠ¶æ€
  console.log('Token:', localStorage.getItem('auth_token'));
  console.log('OpenID:', sessionStorage.getItem('feishu_openid'));

  ç»´æŠ¤å’Œæ‰©å±•

  1. æ—¥å¿—æ”¶é›†

  // å…³é”®æ“ä½œæ—¥å¿—è®°å½•
  const logAuthEvent = (event, data) => {
    const logData = {
      timestamp: Date.now(),
      event,
      data,
      userAgent: navigator.userAgent,
      url: window.location.href
    };

    // å‘é€åˆ°æ—¥å¿—æ”¶é›†æœåŠ¡
    util.request({
      url: '/api/log/auth',
      method: 'POST',
      data: logData
    });
  };

  2. æ‰©å±•æ¥å…¥å…¶ä»–ç™»å½•æ–¹å¼

  // ç»Ÿä¸€ç™»å½•ç®¡ç†å™¨
  class AuthManager {
    async login(provider, credentials) {
      switch(provider) {
        case 'feishu':
          return await this.feishuLogin(credentials);
        case 'wechat':
          return await this.wechatLogin(credentials);
        case 'phone':
          return await this.phoneLogin(credentials);
      }
    }
  }

  3. ç›‘æ§å’Œå‘Šè­¦

  å…³é”®æŒ‡æ ‡ç›‘æ§:
  - SDKåŠ è½½æˆåŠŸç‡
  - æˆæƒæˆåŠŸç‡
  - ç™»å½•æˆåŠŸç‡
  - ç»‘å®šæˆåŠŸç‡
  - å¹³å‡ç™»å½•è€—æ—¶

  å‘Šè­¦è§„åˆ™:
  - SDKåŠ è½½å¤±è´¥ç‡ > 5%
  - æƒé™é”™è¯¯ > 10æ¬¡/å°æ—¶
  - Tokenè¿‡æœŸé”™è¯¯ > 5æ¬¡/å°æ—¶

---
  å¼€å‘å®Œæˆæ ‡å¿—

  âœ… å·²å®ŒæˆåŠŸèƒ½

  1. SDKé›†æˆï¼šé£ä¹¦h5-js-sdkå®Œæ•´é›†æˆå’Œå¤šé‡æ£€æµ‹
  2. æˆæƒæµç¨‹ï¼šä»æˆæƒåˆ°è·å–OpenIDçš„å®Œæ•´æµç¨‹
  3. ç”¨æˆ·ç•Œé¢ï¼šåŠ è½½ã€ç»‘å®šã€æˆåŠŸã€é”™è¯¯å››ç§çŠ¶æ€ç•Œé¢
  4. è°ƒè¯•ç³»ç»Ÿï¼šå®Œæ•´çš„é¡µé¢å’Œconsoleè°ƒè¯•ä¿¡æ¯
  5. é”™è¯¯å¤„ç†ï¼šå„ç§å¼‚å¸¸æƒ…å†µçš„å¤„ç†å’Œç”¨æˆ·å‹å¥½æç¤º
  6. å®‰å…¨æœºåˆ¶ï¼šAppIDè·å–çš„fallbackæœºåˆ¶å’Œæƒé™æ£€æŸ¥

  ğŸ“‹ åç»­å·¥ä½œ

  1. åç«¯æ¥å£è”è°ƒï¼šç¡®ä¿æ‰€æœ‰æ¥å£æŒ‰è§„èŒƒå®ç°
  2. æƒé™é…ç½®ï¼šé£ä¹¦å¼€å‘è€…åå°çš„ç”¨æˆ·æƒé™é…ç½®
  3. ç”Ÿäº§éƒ¨ç½²ï¼šHTTPSç¯å¢ƒå’ŒåŸŸåç™½åå•é…ç½®
  4. ç”¨æˆ·æµ‹è¯•ï¼šçœŸå®åœºæ™¯çš„ç”¨æˆ·ä½“éªŒæµ‹è¯•

---
  æ–‡æ¡£ç‰ˆæœ¬: v2.0æœ€åæ›´æ–°: 2025-08-27ç»´æŠ¤çŠ¶æ€: å¼€å‘å®Œæˆï¼Œç­‰å¾…è”è°ƒ