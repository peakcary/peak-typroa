# é£ä¹¦å…ç™»é—®é¢˜è·Ÿè¿›æ–‡æ¡£

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**æ ¸å¿ƒé—®é¢˜**: é£ä¹¦åº”ç”¨è·³è½¬åˆ°ç³»ç»Ÿæ—¶ï¼Œä»ç„¶ä¼šè¢«è·¯ç”±å®ˆå«æ‹¦æˆªå¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œé£ä¹¦å…ç™»åŠŸèƒ½æœªç”Ÿæ•ˆã€‚

**æœŸæœ›æ•ˆæœ**: é£ä¹¦ç”¨æˆ·è·³è½¬åˆ°ç³»ç»Ÿä»»æ„é¡µé¢æ—¶ï¼Œåº”è¯¥è‡ªåŠ¨é‡å®šå‘åˆ°å…ç™»é¡µé¢è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè€Œä¸æ˜¯è·³è½¬åˆ°æ™®é€šç™»å½•é¡µã€‚

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰çŠ¶æ€
- âœ… å·²å®Œæˆé£ä¹¦å…ç™»é¡µé¢å¼€å‘ (`/user/feishu-auth`)
- âœ… å·²å®Œæˆè·¯ç”±å®ˆå«é€»è¾‘ä¿®æ”¹
- âœ… å·²å®Œæˆåç«¯sessionå¤„ç†é€»è¾‘
- âŒ **çº¿ä¸Šéƒ¨ç½²åä»ç„¶è·³è½¬åˆ°ç™»å½•é¡µé¢**

### æµ‹è¯•æƒ…å†µ
- æœ¬åœ°ä»£ç æµ‹è¯•ï¼šå¯èƒ½æ­£å¸¸ï¼ˆæœªå®Œå…¨éªŒè¯ï¼‰
- çº¿ä¸Šä»£ç æµ‹è¯•ï¼šä»è·³è½¬ç™»å½•é¡µé¢
- ç¡®è®¤é—®é¢˜ï¼šçº¿ä¸Šä»£ç å¯èƒ½æœªæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

## ğŸ› ï¸ å·²å®Œæˆçš„ä¿®æ”¹

### 1. è·¯ç”±å®ˆå«ä¿®æ”¹ (`client/src/router/index.js`)
```javascript
// æ–°å¢çš„å…³é”®é€»è¾‘
router.beforeEach((to, from, next) => {
  // æ£€æŸ¥é£ä¹¦æˆæƒç 
  const feishuCode = to.query.code || new URLSearchParams(window.location.search).get('code');
  
  if (feishuCode && (!user || !user.isLogin)) {
    // é‡å®šå‘åˆ°é£ä¹¦å…ç™»é¡µé¢
    next({
      name: 'userFeishuAuth',
      query: { 
        code: feishuCode,
        redirectUrl: encodeURIComponent(to.fullPath)
      }
    });
  }
  // ... å…¶ä»–é€»è¾‘
});
```

### 2. å…¬å¼€é¡µé¢ç™½åå•
```javascript
const publicRoutes = [
  'index', 'recruitment', 'download',
  'userFeishuAuth',     // é£ä¹¦å…ç™»
  'userFeishuAuthTest', // é£ä¹¦æµ‹è¯•  
  'userDebugAuth',      // è°ƒè¯•é¡µé¢
  'userLogin', 'userLogout', 'userForget',
  'invite', 'infoAbout', 'infoAgreement', 
  'infoPrivacy', 'infoDisclaimer',
  'infoEnterpriseAgreement', 'infoEnterpriseConfirmation',
  '404'
];
```

### 3. è°ƒè¯•æ—¥å¿—
å·²æ·»åŠ è¯¦ç»†çš„æ§åˆ¶å°è°ƒè¯•æ—¥å¿—æ¥è·Ÿè¸ªè·¯ç”±å®ˆå«æ‰§è¡Œæƒ…å†µã€‚

### 4. åç«¯Sessionå¤„ç† (`model/api.js`)
```javascript
// é£ä¹¦å…ç™»sessionç®¡ç†
else if (apiUrl === 'user/fsreglogin' && resultData.isLogin) {
  req.session.user = Object.assign({}, resultData);
}
```

## ğŸš¨ å°šæœªè§£å†³çš„é—®é¢˜

### ä¸»è¦é—®é¢˜
1. **éƒ¨ç½²é—®é¢˜**: æœ¬åœ°ä¿®æ”¹å¯èƒ½æœªæ­£ç¡®éƒ¨ç½²åˆ°çº¿ä¸Š
2. **è·¯ç”±å®ˆå«é€»è¾‘**: å¯èƒ½å­˜åœ¨è¾¹ç•Œæƒ…å†µæœªå¤„ç†
3. **é£ä¹¦è·³è½¬æ ¼å¼**: å®é™…é£ä¹¦è·³è½¬çš„URLæ ¼å¼å¯èƒ½ä¸é¢„æœŸä¸ç¬¦

### å¯èƒ½çš„åŸå› 
1. **ä»£ç ç‰ˆæœ¬ä¸ä¸€è‡´**: çº¿ä¸Šä»£ç ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬
2. **ç¼“å­˜é—®é¢˜**: æµè§ˆå™¨æˆ–CDNç¼“å­˜äº†æ—§ç‰ˆæœ¬ä»£ç 
3. **è·¯ç”±å‚æ•°è§£æ**: Vue Routerå‚æ•°è§£ææ—¶æœºé—®é¢˜
4. **window.ZAIåˆå§‹åŒ–**: ç”¨æˆ·çŠ¶æ€æ£€æŸ¥æ—¶æœºé—®é¢˜

## ğŸ”§ ä¸‹æ¬¡è§£å†³æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¡®è®¤éƒ¨ç½²çŠ¶æ€
```bash
# æ£€æŸ¥çº¿ä¸Šä»£ç ç‰ˆæœ¬
# 1. æŸ¥çœ‹gitæäº¤è®°å½•
git log --oneline -5

# 2. ç¡®è®¤å…³é”®æ–‡ä»¶æ˜¯å¦å·²æ›´æ–°
# æ£€æŸ¥ client/src/router/index.js æ˜¯å¦åŒ…å«æ–°çš„è·¯ç”±å®ˆå«é€»è¾‘

# 3. é‡æ–°éƒ¨ç½²
npm run zf   # ç”Ÿäº§ç¯å¢ƒ
npm run zfd  # æµ‹è¯•ç¯å¢ƒ
```

### ç¬¬äºŒæ­¥ï¼šä½¿ç”¨è°ƒè¯•é¡µé¢æ’æŸ¥
```
è®¿é—®: https://yourdomain.com/user/debug-auth
åŠŸèƒ½: 
- æŸ¥çœ‹å½“å‰è·¯ç”±çŠ¶æ€
- æµ‹è¯•é£ä¹¦è·³è½¬æ¨¡æ‹Ÿ
- è§‚å¯Ÿæ§åˆ¶å°è°ƒè¯•æ—¥å¿—
```

### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥å…·ä½“é”™è¯¯
åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ä»¥ä¸‹ä¿¡æ¯ï¼š
```javascript
// åº”è¯¥çœ‹åˆ°çš„è°ƒè¯•æ—¥å¿—æ ¼å¼
ğŸš€ è·¯ç”±å®ˆå«è°ƒè¯•: {
  to: "é¡µé¢åç§°",
  path: "å®Œæ•´è·¯å¾„", 
  query: {code: "æˆæƒç "},
  user: "ç”¨æˆ·çŠ¶æ€",
  location: "å½“å‰URL"
}

ğŸ” æ£€æŸ¥é£ä¹¦æˆæƒç : {
  routeCode: "è·¯ç”±å‚æ•°ä¸­çš„code",
  urlCode: "URLä¸­çš„code",
  finalCode: "æœ€ç»ˆä½¿ç”¨çš„code"
}
```

### ç¬¬å››æ­¥ï¼šå¯èƒ½çš„ä¿®å¤æ–¹å‘

#### æ–¹æ¡ˆAï¼šè·¯ç”±å®ˆå«æ—¶æœºé—®é¢˜
å¦‚æœVue Routerå‚æ•°è§£ææœ‰é—®é¢˜ï¼Œè€ƒè™‘ä¿®æ”¹ä¸ºï¼š
```javascript
// å»¶è¿Ÿæ£€æŸ¥æˆ–ä½¿ç”¨å…¶ä»–æ–¹å¼è·å–å‚æ•°
setTimeout(() => {
  const feishuCode = new URLSearchParams(window.location.search).get('code');
  // å¤„ç†é€»è¾‘
}, 0);
```

#### æ–¹æ¡ˆBï¼šå¼ºåˆ¶è·³è½¬é€»è¾‘
å¦‚æœè·¯ç”±å®ˆå«ä¸ç”Ÿæ•ˆï¼Œåœ¨å…ç™»é¡µé¢åŠ å…¥ä¸»åŠ¨æ£€æŸ¥ï¼š
```javascript
// åœ¨ feishuAuth.vue çš„ created é’©å­ä¸­
if (!this.$route.query.code) {
  // ä»URLé‡æ–°è§£æå‚æ•°
  const urlCode = new URLSearchParams(window.location.search).get('code');
  if (urlCode) {
    this.$router.replace({
      name: 'userFeishuAuth',
      query: { 
        code: urlCode,
        redirectUrl: this.$route.query.redirectUrl 
      }
    });
  }
}
```

#### æ–¹æ¡ˆCï¼šæ£€æŸ¥é£ä¹¦å®é™…è·³è½¬æ ¼å¼
éœ€è¦ç¡®è®¤é£ä¹¦å®é™…è·³è½¬çš„URLæ ¼å¼æ˜¯å¦ä¸ºï¼š
```
https://yourdomain.com/some/page?code=xxx&state=xxx
```

## ğŸ“ å…³é”®æ–‡ä»¶æ¸…å•

### éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶
```
client/src/router/index.js           # è·¯ç”±å®ˆå«é€»è¾‘
client/src/pages/user/feishuAuth.vue # å…ç™»ä¸»é¡µé¢
client/src/pages/user/debugAuth.vue  # è°ƒè¯•é¡µé¢  
client/src/common/feishuAuth.js      # å·¥å…·å‡½æ•°
model/api.js                         # åç«¯sessionå¤„ç†
```

### æµ‹è¯•URL
```
è°ƒè¯•é¡µé¢: /user/debug-auth
å…ç™»é¡µé¢: /user/feishu-auth
æµ‹è¯•é¡µé¢: /user/feishu-auth-test

æ¨¡æ‹Ÿé£ä¹¦è·³è½¬: /user?code=test123
```

## ğŸ¯ æˆåŠŸæ ‡å¿—

å½“é—®é¢˜è§£å†³åï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¡Œä¸ºï¼š
1. è®¿é—® `/user?code=xxx` è‡ªåŠ¨é‡å®šå‘åˆ° `/user/feishu-auth?code=xxx&redirectUrl=%2Fuser`
2. æ§åˆ¶å°æ˜¾ç¤ºæ­£ç¡®çš„è°ƒè¯•æ—¥å¿—
3. å…ç™»é¡µé¢æ­£å¸¸æ˜¾ç¤ºloadingæˆ–ç»‘å®šè¡¨å•
4. å…ç™»æˆåŠŸåè·³è½¬å›åŸç›®æ ‡é¡µé¢

## ğŸ“ è”ç³»æ–¹å¼

å°†æ­¤æ–‡æ¡£æä¾›ç»™AIåŠ©æ‰‹ï¼Œå¯ä»¥å¿«é€Ÿæ¢å¤é—®é¢˜ä¸Šä¸‹æ–‡å¹¶ç»§ç»­è§£å†³æµç¨‹ã€‚

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-08-15  
**é—®é¢˜çŠ¶æ€**: å¾…è§£å†³  
**ä¼˜å…ˆçº§**: é«˜