# 双面打印功能实现说明

## 概述

本功能实现了基于 `dmDuplex` 参数的智能双面打印支持，允许在 devices 表的 modelData 中为不同的工作流配置单面或双面打印模式。

## 功能特性

### 1. 配置驱动
- 通过 `dmDuplex` 参数控制打印模式
- `dmDuplex = 1`: 单面打印（默认）
- `dmDuplex = 2`: 双面打印
- 配置存储在 `devices` 表的 `modelData` 字段中
- 支持针对不同 `workflowUuid` 设置不同的打印模式

### 2. 智能打印流程

#### 单面打印流程 (dmDuplex = 1)
```
用户点击打印 → submitPrintJob → 获取配置(dmDuplex=1) → 使用原始jobFile → 调用打印API
```

#### 双面打印流程 (dmDuplex = 2)  
```
用户点击打印 → submitPrintJob → 获取配置(dmDuplex=2) → 构建订单数据 → 调用/api/report/smallApp → 提取双面图片URL → 替换jobFile → 调用打印API
```

### 3. 接口集成
- 复用现有的 `/api/report/smallApp` 接口用于双面图片生成
- 支持多种响应格式的图片URL提取
- 完整的错误处理和日志记录
- 15秒超时设置适应双面图片生成时间

## 实现文件

### 核心云函数修改
1. **`cloudfunctions/submitPrintJob/index.js`**
   - 添加双面打印逻辑判断
   - 新增 `buildReportData()` 和 `getDoubleSideImage()` 辅助函数

2. **`cloudfunctions/submitPrintJobNew/index.js`**
   - 同步实现双面打印支持
   - 兼容测试模式，便于开发调试

### 配置文件
3. **`config/print-config-duplex-example.json`**
   - 提供完整的配置示例
   - 包含单面和双面打印的配置模板
   - 详细的数据库结构说明

### 测试页面
4. **`pages/test/duplex-print-test.*`**
   - 完整的测试页面实现
   - 支持功能测试和结果展示
   - 导出测试报告功能

## 数据库配置格式

### devices 表结构示例
```json
{
  "deviceId": "device_001",
  "deviceName": "测试打印设备", 
  "status": 1,
  "modelData": [
    {
      "workflowUuid": "workflow-single-side-001",
      "printConfig": "{\"dmDuplex\":1,\"description\":\"单面打印\",...}"
    },
    {
      "workflowUuid": "workflow-double-side-001", 
      "printConfig": "{\"dmDuplex\":2,\"description\":\"双面打印\",...}"
    }
  ]
}
```

## API 接口要求

### /api/report/smallApp 接口
**用途**: 双面打印时获取合成的双面图片

**请求格式**:
```json
{
  "orderId": "订单号",
  "deviceId": "设备ID",
  "workflowUuid": "工作流UUID",
  "doubleSide": true,
  ...其他订单数据
}
```

**响应格式** (支持多种字段名):
```json
{
  "doubleSideImageUrl": "双面图片URL",
  // 或
  "imageUrl": "图片URL", 
  // 或
  "data": {
    "imageUrl": "图片URL"
  }
}
```

## 使用方法

### 1. 配置设备的双面打印
在数据库中为具体的 workflowUuid 配置 dmDuplex 参数：

```javascript
// 单面打印配置
{
  "workflowUuid": "single-workflow-001",
  "printConfig": "{\"dmDuplex\":1,...其他配置}"
}

// 双面打印配置  
{
  "workflowUuid": "double-workflow-001",
  "printConfig": "{\"dmDuplex\":2,...其他配置}"
}
```

### 2. 调用打印接口
前端调用保持不变，云函数会根据配置自动判断打印模式：

```javascript
wx.cloud.callFunction({
  name: 'submitPrintJob', // 或 submitPrintJobNew
  data: {
    deviceId: 'device_001',
    deviceKey: 'device_key',
    jobFile: 'https://example.com/image.jpg',
    workflowUuid: 'workflow-uuid'
  }
});
```

### 3. 测试功能
使用测试页面 `/pages/test/duplex-print-test` 验证功能：
- 测试单面打印逻辑
- 测试双面打印逻辑
- 验证配置读取正确性

## 技术优势

1. **向下兼容**: 默认 dmDuplex=1，现有配置无需修改
2. **灵活配置**: 支持工作流级别的个性化打印设置
3. **错误处理**: 完整的异常捕获和降级机制
4. **性能优化**: 异步处理，不阻塞用户操作
5. **调试友好**: 详细日志记录，支持测试模式

## 注意事项

1. **接口依赖**: 双面打印依赖 `/api/report/smallApp` 接口正常工作
2. **超时设置**: 双面图片生成可能需要较长时间，已设置15秒超时
3. **数据准确性**: 需要确保订单数据完整，用于双面图片生成
4. **配置验证**: 建议在生产环境使用前充分测试配置正确性

## 提交记录

- `2f3c972`: 集成订单上报功能到payNotify云函数
- `03be9df`: 实现双面打印支持 (dmDuplex配置)  
- `8e5aaf2`: 创建双面打印功能测试页面

---

*文档创建时间: 2025-08-22*
*功能版本: v1.0.0*