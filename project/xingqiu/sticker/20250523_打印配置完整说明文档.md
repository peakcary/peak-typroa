# 打印配置完整说明文档

## 概述

打印配置是控制打印机行为的核心参数集合，存储在数据库的 `devices` 表中，每个工作流（workflowUuid）都有独立的打印配置。配置以 JSON 字符串形式存储在 `modelData[].printConfig` 字段中。

## 数据库结构

### devices 表结构示例
```javascript
{
  "deviceId": "00001",
  "shopTitle": "趣印星球总店", 
  "printDeviceId": "lk30gd37934278",
  "deviceKey": "b1c6s6yHHLJPPxgL",
  "modelData": [
    {
      "workflowUuid": "85ffd9ddbbea48be8db967ee389d5d60",
      "printConfig": "{\"devicePort\":1,\"dmPaperSize\":256,\"dmOrientation\":2,\"dmCopies\":1,\"dmColor\":2,\"dmDefaultSource\":7,\"dmPrintQuality\":-1,\"printerModel\":\"Canon G5080 series\",\"dmDuplex\":1,\"PaperLength\":1480,\"PaperWidth\":2100,\"jpAutoScale\":4,\"enabled\":true,\"description\":\"自选主题小全张-标准配置\"}"
    }
  ]
}
```

## 打印配置参数详解

### 1. 基础设备参数

#### `devicePort` - 设备端口
- **类型**: Number
- **默认值**: 1
- **说明**: 打印机连接端口号
- **示例**: `"devicePort": 1`

#### `printerModel` - 打印机型号
- **类型**: String
- **默认值**: "Canon G5080 series"
- **说明**: 打印机具体型号，用于驱动识别
- **示例**: `"printerModel": "Canon G5080 series"`

### 2. 纸张配置参数

#### `dmPaperSize` - 纸张大小
- **类型**: Number
- **常用值**:
  - `256`: A4 纸 (210 x 297 mm)
  - `11`: Letter 纸 (216 x 279 mm)  
  - `1`: A4 纸 (210 x 297 mm)
- **说明**: Windows 打印机驱动标准纸张大小代码
- **示例**: `"dmPaperSize": 256`

#### `dmOrientation` - 打印方向
- **类型**: Number
- **可选值**:
  - `1`: 纵向（Portrait）
  - `2`: 横向（Landscape）
- **默认值**: 2
- **示例**: `"dmOrientation": 2`

#### `PaperLength` - 纸张长度
- **类型**: Number
- **单位**: 0.1毫米
- **说明**: 自定义纸张长度，如 1480 = 148mm
- **示例**: `"PaperLength": 1480`

#### `PaperWidth` - 纸张宽度
- **类型**: Number
- **单位**: 0.1毫米
- **说明**: 自定义纸张宽度，如 2100 = 210mm
- **示例**: `"PaperWidth": 2100`

### 3. 打印质量参数

#### `dmCopies` - 打印份数
- **类型**: Number
- **默认值**: 1
- **范围**: 1-999
- **示例**: `"dmCopies": 1`

#### `dmColor` - 颜色模式
- **类型**: Number
- **可选值**:
  - `1`: 黑白打印（单色）
  - `2`: 彩色打印
- **默认值**: 2
- **示例**: `"dmColor": 2`

#### `dmPrintQuality` - 打印质量
- **类型**: Number
- **可选值**:
  - `-1`: 标准质量
  - `-2`: 高质量
  - `-3`: 最高质量
  - `-4`: 草稿质量（快速）
- **默认值**: -1
- **示例**: `"dmPrintQuality": -1`

#### `dmDefaultSource` - 纸张来源
- **类型**: Number
- **常用值**:
  - `7`: 自动选择纸盒
  - `1`: 上纸盒
  - `2`: 下纸盒
- **默认值**: 7
- **示例**: `"dmDefaultSource": 7`

### 4. 双面打印参数 ⭐

#### `dmDuplex` - 双面打印模式
- **类型**: Number
- **可选值**:
  - `1`: 单面打印
  - `2`: 双面打印（长边翻页）
  - `3`: 双面打印（短边翻页）
- **默认值**: 1
- **重要**: 这是控制单面/双面打印的核心参数
- **示例**: `"dmDuplex": 2`

### 5. 缩放和处理参数

#### `jpAutoScale` - 自动缩放模式
- **类型**: Number
- **可选值**:
  - `1`: 不缩放
  - `2`: 适应页面
  - `3`: 适应宽度
  - `4`: 适应高度
- **默认值**: 4
- **示例**: `"jpAutoScale": 4`

### 6. 扩展参数

#### `enabled` - 配置启用状态
- **类型**: Boolean
- **默认值**: true
- **说明**: 控制此配置是否生效
- **示例**: `"enabled": true`

#### `description` - 配置描述
- **类型**: String
- **说明**: 配置的人性化描述，便于管理
- **示例**: `"description": "自选主题小全张-标准配置"`

#### `photoMode` - 照片模式（可选）
- **类型**: Boolean
- **默认值**: false
- **说明**: 启用照片优化打印
- **示例**: `"photoMode": true`

#### `borderless` - 无边框打印（可选）
- **类型**: Boolean
- **默认值**: false
- **说明**: 启用无边框打印
- **示例**: `"borderless": true`

#### `draft` - 草稿模式（可选）
- **类型**: Boolean
- **默认值**: false
- **说明**: 快速草稿打印模式
- **示例**: `"draft": true`

## 配置示例

### 1. 单面打印配置
```json
{
  "devicePort": 1,
  "dmPaperSize": 256,
  "dmOrientation": 2,
  "dmCopies": 1,
  "dmColor": 2,
  "dmDefaultSource": 7,
  "dmPrintQuality": -1,
  "printerModel": "Canon G5080 series",
  "dmDuplex": 1,
  "PaperLength": 1480,
  "PaperWidth": 2100,
  "jpAutoScale": 4,
  "enabled": true,
  "description": "单面打印-标准配置"
}
```

### 2. 双面打印配置
```json
{
  "devicePort": 1,
  "dmPaperSize": 256,
  "dmOrientation": 2,
  "dmCopies": 1,
  "dmColor": 2,
  "dmDefaultSource": 7,
  "dmPrintQuality": -1,
  "printerModel": "Canon G5080 series",
  "dmDuplex": 2,
  "PaperLength": 1480,
  "PaperWidth": 2100,
  "jpAutoScale": 4,
  "enabled": true,
  "description": "双面打印-自动获取背面图片"
}
```

### 3. 高质量打印配置
```json
{
  "devicePort": 1,
  "dmPaperSize": 256,
  "dmOrientation": 1,
  "dmCopies": 1,
  "dmColor": 2,
  "dmPrintQuality": -3,
  "printerModel": "Canon G5080 series",
  "dmDuplex": 1,
  "photoMode": true,
  "borderless": true,
  "colorProfile": "sRGB",
  "resolution": 300,
  "enabled": true,
  "description": "专业照片打印-高质量无边框"
}
```

### 4. 草稿模式配置
```json
{
  "devicePort": 1,
  "dmPaperSize": 256,
  "dmOrientation": 2,
  "dmCopies": 1,
  "dmColor": 1,
  "dmPrintQuality": -4,
  "printerModel": "Canon G5080 series",
  "dmDuplex": 1,
  "draft": true,
  "fastMode": true,
  "enabled": true,
  "description": "草稿模式-快速黑白打印"
}
```

### 5. 黑白节省模式
```json
{
  "devicePort": 1,
  "dmPaperSize": 256,
  "dmOrientation": 2,
  "dmCopies": 1,
  "dmColor": 1,
  "dmDefaultSource": 7,
  "dmPrintQuality": -3,
  "printerModel": "Canon G5080 series",
  "dmDuplex": 1,
  "PaperLength": 2970,
  "PaperWidth": 2100,
  "jpAutoScale": 1,
  "enabled": true,
  "description": "报纸头条-黑白横向打印节省成本"
}
```

## 如何配置

### 1. 数据库配置方式

#### 方式一：直接修改数据库
1. 连接到 MongoDB 数据库
2. 找到 `devices` 集合
3. 定位到对应的设备文档
4. 修改 `modelData` 数组中对应 `workflowUuid` 的 `printConfig` 字段

```javascript
// 更新示例
db.devices.updateOne(
  { "deviceId": "00001", "modelData.workflowUuid": "85ffd9ddbbea48be8db967ee389d5d60" },
  { 
    "$set": { 
      "modelData.$.printConfig": "{\"devicePort\":1,\"dmPaperSize\":256,\"dmOrientation\":2,\"dmCopies\":1,\"dmColor\":2,\"dmDefaultSource\":7,\"dmPrintQuality\":-1,\"printerModel\":\"Canon G5080 series\",\"dmDuplex\":2,\"PaperLength\":1480,\"PaperWidth\":2100,\"jpAutoScale\":4,\"enabled\":true,\"description\":\"双面打印配置\"}"
    } 
  }
)
```

#### 方式二：通过云函数更新
创建管理云函数来更新打印配置：

```javascript
// 云函数示例：updatePrintConfig
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const { deviceId, workflowUuid, printConfig } = event;
  
  // 验证配置
  let config;
  try {
    config = typeof printConfig === 'string' ? JSON.parse(printConfig) : printConfig;
  } catch (error) {
    return { code: 1, message: '配置格式错误' };
  }
  
  // 更新数据库
  const result = await db.collection('devices')
    .where({ deviceId })
    .update({
      data: {
        [`modelData.$[elem].printConfig`]: JSON.stringify(config)
      },
      arrayFilters: [{ 'elem.workflowUuid': workflowUuid }]
    });
    
  return { code: 0, message: '配置更新成功', result };
};
```

### 2. 前端管理界面配置

可以创建管理后台页面，提供可视化的配置界面：

```javascript
// 管理页面示例代码
Page({
  data: {
    currentConfig: {},
    deviceId: '',
    workflowUuid: ''
  },
  
  // 加载当前配置
  loadConfig() {
    wx.cloud.callFunction({
      name: 'getDeviceConfig',
      data: {
        deviceId: this.data.deviceId,
        workflowUuid: this.data.workflowUuid
      },
      success: res => {
        this.setData({ currentConfig: res.result.printConfig });
      }
    });
  },
  
  // 保存配置
  saveConfig() {
    wx.cloud.callFunction({
      name: 'updatePrintConfig',
      data: {
        deviceId: this.data.deviceId,
        workflowUuid: this.data.workflowUuid,
        printConfig: this.data.currentConfig
      },
      success: res => {
        wx.showToast({ title: '配置保存成功', icon: 'success' });
      }
    });
  },
  
  // 切换双面打印
  toggleDuplex(e) {
    const dmDuplex = e.detail.value ? 2 : 1;
    this.setData({ 
      'currentConfig.dmDuplex': dmDuplex 
    });
  }
});
```

## 配置获取优先级

系统按以下优先级获取打印配置：

1. **前端传递的配置**（最高优先级）
   - 小程序页面直接传递给云函数的配置参数

2. **数据库存储的设备配置**
   - 从 `devices` 表的 `modelData[].printConfig` 获取

3. **系统默认配置**（最低优先级）
   - 当前面两种都不可用时的后备配置

```javascript
// 配置获取逻辑示例
async function getPrintConfig(deviceId, workflowUuid, frontendConfig) {
  // 优先级1：前端传递的配置
  if (frontendConfig && Object.keys(frontendConfig).length > 0) {
    console.log('使用前端传递的打印配置');
    return { ...getDefaultConfig(), ...frontendConfig };
  }
  
  // 优先级2：数据库配置
  const dbConfig = await getConfigFromDatabase(deviceId, workflowUuid);
  if (dbConfig) {
    console.log('使用数据库存储的打印配置');
    return dbConfig;
  }
  
  // 优先级3：默认配置
  console.log('使用系统默认打印配置');
  return getDefaultConfig();
}
```

## 双面打印特殊配置

### dmDuplex 参数详解

双面打印的核心在于 `dmDuplex` 参数：

- **`dmDuplex: 1`** - 单面打印
  - 直接使用 `jobFile` 参数中的图片进行打印
  - 无需额外处理

- **`dmDuplex: 2`** - 双面打印（长边翻页）
  - 系统会从缓存获取二维码图片作为背面
  - `jobFile` 变为数组：`[正面图片URL, 背面图片URL]`

### 双面打印配置示例

```json
{
  "workflowUuid": "workflow-double-side-001",
  "printConfig": {
    "devicePort": 1,
    "dmPaperSize": 256,
    "dmOrientation": 2,
    "dmCopies": 1,
    "dmColor": 2,
    "dmDefaultSource": 7,
    "dmPrintQuality": -1,
    "printerModel": "Canon G5080 series",
    "dmDuplex": 2,
    "PaperLength": 1480,
    "PaperWidth": 2100,
    "jpAutoScale": 4,
    "enabled": true,
    "description": "双面打印-自动从缓存获取二维码"
  }
}
```

## 配置验证

建议在设置配置时进行验证：

```javascript
function validatePrintConfig(config) {
  const errors = [];
  
  // 必需字段检查
  if (!config.devicePort || config.devicePort < 1) {
    errors.push('devicePort 必须大于0');
  }
  
  // dmDuplex 值检查
  if (config.dmDuplex && ![1, 2, 3].includes(config.dmDuplex)) {
    errors.push('dmDuplex 只能是 1(单面) 或 2(双面长边) 或 3(双面短边)');
  }
  
  // dmColor 值检查
  if (config.dmColor && ![1, 2].includes(config.dmColor)) {
    errors.push('dmColor 只能是 1(黑白) 或 2(彩色)');
  }
  
  // dmOrientation 值检查
  if (config.dmOrientation && ![1, 2].includes(config.dmOrientation)) {
    errors.push('dmOrientation 只能是 1(纵向) 或 2(横向)');
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}
```

## 最佳实践

1. **配置备份**：修改配置前先备份原配置
2. **逐步测试**：新配置先在测试设备上验证
3. **文档记录**：为每个配置添加详细的 description 说明
4. **版本管理**：重要配置变更要记录版本信息
5. **监控告警**：配置错误要有相应的监控和告警机制

## 常见问题

### Q1: dmDuplex 设置为 2 但不能双面打印？
**A**: 检查以下几点：
- 打印机是否支持双面打印
- `printerModel` 是否正确
- 二维码缓存是否正常获取

### Q2: 配置修改后不生效？
**A**: 检查以下几点：
- JSON 格式是否正确
- 配置是否成功保存到数据库
- 前端是否有缓存需要清除

### Q3: 如何测试打印配置？
**A**: 建议步骤：
1. 先用测试图片进行单面打印测试
2. 确认单面打印正常后测试双面打印
3. 检查打印质量和纸张适配情况

通过本文档，您应该能够完全理解和配置打印系统的各种参数，实现符合需求的打印效果。