# 异常监控系统使用指南

## 🎯 系统概述

异常监控系统专门用于捕获和分析线上打印、支付等业务异常，帮助运营人员快速定位和解决问题，提升系统稳定性和用户体验。

## 📋 核心功能

### 1. 自动异常捕获
- **打印异常**：配置解析错误、API调用失败、设备离线等
- **支付异常**：支付失败、超时、验证错误等
- **配置异常**：JSON格式错误、字段类型错误、配置缺失等
- **系统异常**：云函数执行失败、数据库连接错误等

### 2. 智能分类和分析
- **严重程度**：Critical（严重）、Error（错误）、Warning（警告）、Info（信息）
- **业务分类**：打印任务、支付相关、配置问题、数据库操作等
- **影响评估**：用户影响、业务影响、预估损失等

### 3. 实时监控面板
- **快速统计**：24小时异常数、严重异常数、待处理数等
- **趋势分析**：异常数量变化趋势、峰值时段分析
- **设备分析**：异常最多的设备TOP5
- **实时告警**：严重异常自动告警

## 🚀 部署步骤

### 1. 创建数据表
在微信云开发控制台创建 `exception_logs` 表，参考 `database-schema/exception_logs.json`

### 2. 部署云函数
```bash
# 上传工具函数（可选，作为共享库）
utils/exception-logger.js

# 部署查询云函数
cloudfunctions/queryExceptions/

# 更新现有打印云函数（集成异常监控）
cloudfunctions/submitPrintJobNew/enhanced-index.js
cloudfunctions/submitPrintJob/enhanced-index.js
```

### 3. 配置权限
确保云函数有以下权限：
- `exception_logs` 表读写权限
- `devices` 表读权限

### 4. 前端集成
- 复制运营面板代码：`pages/admin/exception-dashboard.js`
- 在管理员页面添加入口

## 📊 使用方法

### 1. 查询异常列表
```javascript
wx.cloud.callFunction({
  name: 'queryExceptions',
  data: {
    action: 'query',
    filters: {
      severity: 'error',        // 严重程度筛选
      category: 'print_job',    // 业务类别筛选
      deviceId: '00006',        // 设备筛选
      resolved: false           // 是否已解决
    },
    timeRange: {
      start: '2025-01-20T00:00:00.000Z',
      end: '2025-01-21T23:59:59.999Z'
    },
    limit: 50,
    skip: 0
  }
});
```

### 2. 获取异常汇总
```javascript
wx.cloud.callFunction({
  name: 'queryExceptions',
  data: {
    action: 'summary',
    timeRange: {
      start: '2025-01-21T00:00:00.000Z',
      end: '2025-01-21T23:59:59.999Z'
    }
  }
});
```

### 3. 获取实时统计
```javascript
wx.cloud.callFunction({
  name: 'queryExceptions',
  data: {
    action: 'stats'
  }
});
```

### 4. 标记异常为已解决
```javascript
wx.cloud.callFunction({
  name: 'queryExceptions',
  data: {
    action: 'resolve',
    exceptionId: 'exception_id_here',
    resolution: {
      resolvedBy: 'operator_name',
      solution: '问题解决方案描述',
      preventionMeasures: '预防措施',
      followUpRequired: false
    }
  }
});
```

### 5. 获取趋势数据
```javascript
wx.cloud.callFunction({
  name: 'queryExceptions',
  data: {
    action: 'trend',
    timeRange: {
      start: '2025-01-14T00:00:00.000Z',
      end: '2025-01-21T23:59:59.999Z'
    }
  }
});
```

## 🔧 高级配置

### 1. 自定义告警规则
在 `exception-logger.js` 的 `triggerAlert` 函数中配置：
- 企业微信机器人通知
- 邮件告警
- 短信通知

### 2. 扩展异常类型
在 `CATEGORY` 和 `SUBCATEGORY` 中添加新的分类：
```javascript
const CATEGORY = {
  PRINT_JOB: 'print_job',
  PAYMENT: 'payment',
  CONFIG: 'config',
  YOUR_CUSTOM: 'your_custom'  // 添加自定义类别
};
```

### 3. 自定义监控指标
扩展 `impact_analysis` 字段：
```javascript
impact_analysis: {
  userImpact: 'high',
  businessImpact: 'medium',
  customMetric: 'your_value'  // 添加自定义指标
}
```

## 📈 监控最佳实践

### 1. 异常处理优先级
- **Critical**：立即处理，5分钟内响应
- **Error**：当天处理，2小时内响应
- **Warning**：3天内处理
- **Info**：定期回顾

### 2. 常见问题解决方案

#### 打印配置解析错误
```javascript
// 问题：JSON格式错误
// 解决：使用配置验证工具修复
wx.cloud.callFunction({
  name: 'validatePrintConfigs',
  data: { fixErrors: true }
});
```

#### 打印API调用失败
- 检查设备状态和网络连接
- 验证设备密钥是否正确
- 检查打印文件URL是否有效

#### 支付异常处理
- 检查支付参数和金额
- 验证用户支付状态
- 联系支付服务提供商

### 3. 预防性监控
- 设置异常数量阈值告警
- 监控关键设备异常率
- 定期检查配置完整性
- 分析异常趋势并预防

## 🎨 运营面板功能

### 1. 实时监控
- 24小时异常统计
- 严重异常计数
- 待处理异常数
- 最近异常列表

### 2. 趋势分析
- 异常数量变化图表
- 按小时/天的分布
- 设备异常排行
- 类别分布统计

### 3. 批量操作
- 批量标记已解决
- 导出异常报告
- 筛选和搜索
- 快速操作面板

## ⚡ 性能优化建议

### 1. 数据库优化
- 为常用查询字段创建索引
- 定期清理历史数据（保留3个月）
- 使用分页查询避免大量数据加载

### 2. 查询优化
```javascript
// 推荐：使用时间范围和索引字段
{ timestamp: db.command.gte(startTime), severity: 'error' }

// 避免：全表扫描
{ description: db.RegExp('某个关键词') }
```

### 3. 异步处理
```javascript
// 推荐：异步记录异常，不阻塞主流程
logPrintException(errorData).catch(err => {
  console.error('记录异常失败:', err);
});
```

## 🚨 故障排除

### 1. 异常记录失败
- 检查数据库权限
- 验证数据格式
- 查看云函数日志

### 2. 查询性能慢
- 检查索引配置
- 优化查询条件
- 减少返回数据量

### 3. 告警不及时
- 检查告警配置
- 验证通知渠道
- 调整告警阈值

---

**版本**: v1.0  
**更新时间**: 2025-01-21  
**维护人**: 开发团队