# 公司认证系统重构技术文档

## 📋 项目概述

本次对公司认证系统进行了全面重构，主要目标是简化认证流程，统一认证平台，并提升用户体验。将复杂的4-5步认证流程简化为2步流程，完全采用契约锁认证平台。

## 🎯 重构目标

1. **流程简化**: 从复杂的4-5步流程简化为2步流程
2. **平台统一**: 完全采用契约锁认证平台，移除e签宝相关代码
3. **权限开放**: 移除公司权限限制，允许用户为任意公司申请认证
4. **体验优化**: 提供更灵活的表单填写和验证机制
5. **代码优化**: 清理冗余代码，修复现有问题

## 🔧 核心修改内容

### 1. 流程架构重构

#### 原始流程（4-5步）
```
选择公司 → 填写基本信息 → 证件验证 → 法人信息确认 → 完成认证
```

#### 新流程（2步）
```
填写基本信息 → 跳转契约锁完成认证
```

### 2. 表单结构优化

#### 移除的字段
- ❌ 组织机构代码 (`orgCode`)
- ❌ 法人姓名 (`legalRepName`) 
- ❌ 法人证件号 (`legalRepIdNo`)

#### 保留/新增的字段
- ✅ 公司选择 (可选，不再必填)
- ✅ 组织机构名称 (必填，可手动编辑)
- ✅ 联系方式类型 (新增：手机/邮箱选择)
- ✅ 联系方式 (必填，支持手机号和邮箱)

### 3. API接口更新

#### 接口变更
```javascript
// 原接口 (权限限制)
await getOption.getRoleCompanyList(); // /core/org/om/company/list/roles

// 新接口 (无权限限制)  
await getOption.getCompanyList(); // /core/sm/company/list
```

#### 提交参数格式
```javascript
// 新的API参数结构
const requestData = {
  companyName: this.form.name,      // 组织机构名称
  applicant: {
    contact: this.form.contact,      // 联系方式
    contactType: this.form.contactType // MOBILE 或 EMAIL
  }
};
```

## 📝 详细代码修改

### 1. 核心组件文件：`/src/views/Sign/CompanyAttest/companyAttest.vue`

#### 表单结构修改

```vue
<template>
  <!-- 移除了复杂的多步骤表单，简化为单步表单 -->
  <CloudForm v-if="current === 0" :model="form" ref="form" :rules="ruleInline">
    
    <!-- 公司选择 - 移除必填验证 -->
    <CloudFormItem :label="$t('table06')">
      <CloudSelect v-model="form.company" @on-change="changeCompany">
        <template v-for="item in companyOptions">
          <CloudOption :label="item.value" :value="item.id" :key="item.id">
            {{ item.value }}
          </CloudOption>
        </template>
      </CloudSelect>
    </CloudFormItem>

    <!-- 组织机构名称 - 改为可编辑 -->
    <CloudFormItem :label="$t('info41')" prop="name">
      <CloudInput v-model="form.name" :placeholder="$t('placeholder204')"></CloudInput>
    </CloudFormItem>

    <!-- 新增：联系方式类型选择 -->
    <CloudFormItem label="联系方式类型" prop="contactType">
      <CloudSelect v-model="form.contactType" @on-change="changeContactType">
        <CloudOption value="MOBILE" label="手机号码">手机号码</CloudOption>
        <CloudOption value="EMAIL" label="邮箱地址">邮箱地址</CloudOption>
      </CloudSelect>
    </CloudFormItem>

    <!-- 联系方式输入 - 动态标签和验证 -->
    <CloudFormItem 
      :label="form.contactType === 'MOBILE' ? '手机号码' : '邮箱地址'"
      prop="contact">
      <CloudInput
        v-model="form.contact"
        :placeholder="form.contactType === 'MOBILE' ? $t('placeholder616') : '请输入邮箱地址'"
        @keyup.enter.native="submitForm()">
      </CloudInput>
    </CloudFormItem>

  </CloudForm>
</template>
```

#### 数据结构简化

```javascript
// 原始复杂数据结构
form: {
  company: '',
  name: '',
  orgCode: '',           // ❌ 移除
  legalRepName: '',      // ❌ 移除  
  legalRepIdNo: '',      // ❌ 移除
  contactType: 'MOBILE', // ✅ 新增
  contact: '',           // ✅ 新增
}

// 简化后的数据结构
form: {
  company: '',           // 可选
  name: '',             // 必填，可编辑
  contactType: 'MOBILE', // 必填
  contact: '',          // 必填
}
```

#### 验证规则优化

```javascript
// 移除复杂验证，只保留核心验证
ruleInline: {
  // ❌ 移除公司必填验证
  // company: [{ required: true, message: this.$t('placeholder544'), trigger: 'blur' }],
  
  name: [{ required: true, message: this.$t('placeholder204'), trigger: 'blur' }],
  contactType: [{ required: true, message: '请选择联系方式类型', trigger: 'blur' }],
  contact: [
    { required: true, message: this.$t('placeholder443'), trigger: 'blur' },
    {
      validator: (rule, value, callback) => {
        if (this.form.contactType === 'MOBILE') {
          if (this.$rules.phoneNum11.pattern.test(value)) {
            callback();
          } else {
            callback(new Error(this.$t('placeholder30')));
          }
        } else if (this.form.contactType === 'EMAIL') {
          if (this.$rules.email.pattern.test(value)) {
            callback();
          } else {
            callback(new Error('请输入正确的邮箱地址'));
          }
        } else {
          callback();
        }
      },
      trigger: 'blur'
    }
  ],
}
```

### 2. API调用逻辑重构

#### 公司列表获取

```javascript
// 原逻辑：权限限制
async getOptions() {
  const res = await getOption.getRoleCompanyList(); // 只显示有权限的公司
  this.companyOptions = res ? res.data : [];
}

// 新逻辑：无权限限制
async getOptions() {
  const res = await getOption.getCompanyList(); // 显示所有公司
  this.companyOptions = res ? res.data : [];
}
```

#### 用户信息加载和自动填充

```javascript
// 用户信息加载逻辑
async loadUserInfo() {
  try {
    // 优先从store获取
    if (
      this.$store.state.user.userInfo &&
      (this.$store.state.user.userInfo.mobile ||
       this.$store.state.user.userInfo.email ||
       this.$store.state.user.userInfo.mailbox)
    ) {
      this.userInfo = this.$store.state.user.userInfo;
    } else {
      // 从API获取
      const res = await getUserInfo();
      if (res && res.data) {
        this.userInfo = res.data;
      }
    }
    
    // 设置默认联系方式
    this.setDefaultContact();
  } catch (error) {
    // 获取用户信息失败，使用默认值
  }
}

// 联系方式类型切换逻辑
changeContactType(type) {
  this.form.contactType = type;
  if (type === 'MOBILE' && this.userInfo.mobile) {
    this.form.contact = this.userInfo.mobile;
  } else if (type === 'EMAIL' && (this.userInfo.mailbox || this.userInfo.email)) {
    this.form.contact = this.userInfo.mailbox || this.userInfo.email;
  } else {
    this.form.contact = '';
  }
}
```

#### 表单提交逻辑

```javascript
// 统一的提交逻辑，参考个人认证流程
async submitForm() {
  this.$refs.form.validate(async valid => {
    if (valid) {
      this.loading = true;
      
      // 构造新的API参数格式
      const requestData = {
        companyName: this.form.name,
        applicant: {
          contact: this.form.contact,
          contactType: this.form.contactType
        }
      };
      
      try {
        const res = await companySign(requestData);
        
        if (res && res.data) {
          this.current = 1;
          // 直接跳转到契约锁认证页面（与个人认证一致）
          location.href = res.data;
        } else {
          this.loading = false;
          this.$Message.error('认证失败，请重试');
        }
      } catch (error) {
        console.error('API调用失败:', error);
        this.loading = false;
        this.$Message.error('网络错误，请重试');
      }
    }
  });
}
```

### 3. 工具类修复：`/src/utils/rules.js`

#### 邮箱验证规则缺失问题修复

```javascript
// 发现并修复了缺失的email验证规则
const email = {
  pattern: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
};

export default {
  // ... 其他规则
  email, // ✅ 新增邮箱验证规则
};
```

### 4. 国际化优化

#### 已国际化的内容
```javascript
// 使用现有的国际化key
message: this.$t('placeholder544'),    // 请选择公司
message: this.$t('placeholder204'),    // 请输入组织机构名称  
message: this.$t('placeholder443'),    // 请输入联系方式
message: this.$t('placeholder30'),     // 请输入正确的手机号码
:placeholder="$t('placeholder616')",   // 请输入手机号码
```

#### 待国际化的内容（已标记TODO）
```javascript
// 需要在i18n文件中添加对应的key
label="联系方式类型"                    // TODO: 需要国际化
placeholder="请选择联系方式类型"         // TODO: 需要国际化  
"手机号码" / "邮箱地址"                // TODO: 需要国际化
callback(new Error('请输入正确的邮箱地址')) // TODO: 需要国际化
this.$Message.error('认证失败，请重试')   // TODO: 需要国际化
```

## 🚀 功能特性

### 1. 灵活的公司选择机制
- **可选填写**: 公司选择不再是必填项
- **自动填充**: 选择公司后自动填充组织机构名称
- **手动编辑**: 支持手动修改组织机构名称
- **无权限限制**: 可以选择任意公司

### 2. 智能的联系方式处理
- **类型选择**: 支持手机号和邮箱两种联系方式
- **自动填充**: 根据用户信息自动填充默认联系方式
- **动态验证**: 根据联系方式类型进行相应的格式验证
- **用户友好**: 提供清晰的标签和提示

### 3. 统一的认证平台
- **契约锁平台**: 完全采用契约锁认证，与个人认证保持一致
- **直接跳转**: 提交后直接跳转到第三方认证页面
- **无中间步骤**: 消除复杂的中间验证流程

## 🔧 技术亮点

### 1. 代码复用和一致性
- 参考个人认证流程，保持代码风格一致
- 复用现有的验证规则和工具函数
- 统一的错误处理和用户反馈机制

### 2. 用户体验优化
- 移除不必要的loading状态
- 提供即时的表单验证反馈
- 智能的默认值填充

### 3. 错误处理和调试
- 完善的try-catch错误捕获
- 详细的调试信息输出
- 友好的用户错误提示

## 📊 对比分析

| 方面 | 原系统 | 新系统 | 改进 |
|------|-------|--------|------|
| 认证步骤 | 4-5步 | 2步 | 简化60% |
| 必填字段 | 7个 | 3个 | 减少57% |
| 权限限制 | 严格 | 开放 | 更灵活 |
| 用户体验 | 复杂 | 简洁 | 大幅提升 |
| 代码维护 | 复杂 | 简单 | 易维护 |
| 认证平台 | 混合 | 统一 | 更一致 |

## 🐛 问题修复记录

### 1. 邮箱验证规则缺失
- **问题**: 代码中使用`this.$rules.email`但规则文件中未定义
- **影响**: 导致JavaScript错误和表单验证失败
- **解决**: 在`rules.js`中添加标准邮箱验证规则

### 2. Loading状态干扰用户输入
- **问题**: 不当的loading状态影响用户输入体验
- **影响**: 用户输入时出现不必要的loading动画
- **解决**: 移除输入框的loading属性，优化用户体验

### 3. 权限验证过于严格
- **问题**: 公司权限限制导致用户无法灵活选择
- **影响**: 限制了系统的适用场景
- **解决**: 移除权限限制，开放公司选择

### 4. 公司选择必填验证
- **问题**: 强制要求选择公司，限制了使用灵活性
- **影响**: 用户必须从下拉列表选择公司才能继续
- **解决**: 完全移除公司选择的必填验证

## 🎯 未来优化建议

### 1. 国际化完善
- 为所有硬编码中文添加国际化支持
- 支持多语言切换

### 2. 表单验证增强
- 添加更多联系方式类型支持
- 实现实时验证提示

### 3. 错误处理优化
- 添加更详细的错误码处理
- 提供更精确的错误提示

### 4. 性能优化
- 实现表单数据的本地缓存
- 优化API调用频率

## 📋 文件修改清单

### 主要修改文件
1. `/src/views/Sign/CompanyAttest/companyAttest.vue` - 核心组件重构
2. `/src/utils/rules.js` - 添加邮箱验证规则
3. `/src/api/sign/index.js` - API接口配置（已存在，无需修改）

### 依赖的现有文件
1. `/src/api/Personnel/common.js` - 公司列表API
2. `/src/api/user/user.js` - 用户信息API  
3. `/src/i18n/langs/cn.js` - 国际化配置

## 🔄 部署和测试

### 测试重点
1. **表单验证**: 测试各种输入组合的验证逻辑
2. **API调用**: 验证新的参数格式是否正确
3. **用户体验**: 测试表单填写的流畅性
4. **错误处理**: 测试各种异常情况的处理

### 部署注意事项
1. 确保后端API `/core/report/sign/authCompany` 支持新的参数格式
2. 验证契约锁认证平台的跳转链接有效性
3. 测试不同用户角色的访问权限

## 📞 API调用示例和调试

### API端点
```
POST /core/report/sign/authCompany
```

### 请求参数
```json
{
  "companyName": "苏州路卡信息科技有限公司",
  "applicant": {
    "contact": "peak.zhang@2175.cn33",
    "contactType": "EMAIL"
  }
}
```

### 常见400错误排查
1. **检查参数完整性**: 确保companyName不为空
2. **验证联系方式格式**: 手机号11位数字，邮箱符合标准格式
3. **确认contactType值**: 必须是"MOBILE"或"EMAIL" 
4. **检查请求头**: 确保Content-Type和认证信息正确

---

**文档版本**: v1.0  
**最后更新**: 2025-08-29  
**作者**: Claude Assistant  
**审核状态**: 待审核