# 公司认证系统测试指南文档

## 📝 文档说明

本文档记录了公司认证系统的重构修改内容，以及需要进行的测试验证。由于当前后端服务器存在500错误问题，无法完成完整测试，需要在服务器恢复后继续测试验证。

## 🎯 本次修改概述

### 核心改动
1. **流程简化**: 4-5步流程 → 2步流程
2. **字段精简**: 移除组织机构代码、法人姓名、法人证件号
3. **验证放宽**: 移除公司选择必填验证
4. **功能增强**: 新增联系方式类型选择（手机/邮箱）
5. **权限调整**: 组织机构名称改为可编辑
6. **问题修复**: 添加缺失的邮箱验证规则

## 🔧 技术修改详情

### 1. 主要文件修改

#### `/src/views/Sign/CompanyAttest/companyAttest.vue`

**表单结构变更**：
```vue
<!-- 保留的字段 -->
<CloudFormItem :label="$t('table06')">              <!-- 公司（可选） -->
<CloudFormItem :label="$t('info41')" prop="name">   <!-- 组织机构名称（必填，可编辑） -->
<CloudFormItem label="联系方式类型" prop="contactType"> <!-- 新增：手机/邮箱选择 -->
<CloudFormItem :label="..." prop="contact">         <!-- 联系方式（必填，动态验证） -->

<!-- 移除的字段 -->
❌ 组织机构代码 (orgCode)
❌ 法人姓名 (legalRepName) 
❌ 法人证件号 (legalRepIdNo)
```

**数据结构变更**：
```javascript
// 新的表单数据结构
form: {
  company: '',           // 可选，不再必填
  name: '',             // 必填，可编辑
  contactType: 'MOBILE', // 必填，新增字段
  contact: '',          // 必填，新增字段
}
```

**验证规则变更**：
```javascript
ruleInline: {
  // ❌ 移除：company: [{ required: true, ... }]
  name: [{ required: true, message: this.$t('placeholder204'), trigger: 'blur' }],
  contactType: [{ required: true, message: '请选择联系方式类型', trigger: 'blur' }],
  contact: [
    { required: true, message: this.$t('placeholder443'), trigger: 'blur' },
    { validator: 动态验证手机号或邮箱格式 }
  ],
}
```

**API调用变更**：
```javascript
// 提交参数格式
const requestData = {
  companyName: this.form.name,      // 组织机构名称
  applicant: {
    contact: this.form.contact,      // 联系方式
    contactType: this.form.contactType // MOBILE 或 EMAIL
  }
};

// API端点
await companySign(requestData); // POST /core/report/sign/authCompany
```

#### `/src/utils/rules.js`

**新增邮箱验证规则**：
```javascript
// 修复缺失的邮箱验证规则
const email = {
  pattern: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
};

export default {
  // ... 其他规则
  email, // 新增
};
```

## 🧪 测试计划

### 前提条件
- [ ] 后端服务器恢复正常
- [ ] API接口返回200状态码
- [ ] 用户已登录系统

### 1. 基础功能测试

#### 1.1 页面加载测试
- [ ] 访问公司认证页面
- [ ] 检查页面正常渲染
- [ ] 验证2步流程界面显示正确

#### 1.2 公司列表测试
- [ ] 验证公司下拉列表正常加载
- [ ] 检查下拉选项显示公司名称
- [ ] 确认选择公司后自动填充组织机构名称

### 2. 表单功能测试

#### 2.1 公司选择测试
```
测试步骤：
1. 不选择任何公司，直接填写其他信息
2. 验证表单可以正常提交（公司选择不再必填）

期望结果：
✅ 不会出现"请选择公司"的验证错误
✅ 可以成功提交表单
```

#### 2.2 组织机构名称测试
```
测试步骤：
1. 选择公司，观察组织机构名称自动填充
2. 手动修改组织机构名称
3. 提交表单

期望结果：  
✅ 选择公司后自动填充名称
✅ 可以手动编辑名称（不再是只读）
✅ 提交时使用用户编辑的名称
```

#### 2.3 联系方式类型测试
```
测试步骤：
1. 默认选择手机号类型
2. 切换到邮箱类型
3. 再切换回手机号类型

期望结果：
✅ 切换类型时不出现loading状态
✅ 标签和placeholder正确更新
✅ 如果有用户信息，会自动填充对应的联系方式
```

#### 2.4 联系方式验证测试
```
手机号验证：
- 输入：13812345678 → ✅ 通过验证
- 输入：1381234567 → ❌ 提示"请输入正确的手机号码"
- 输入：abc → ❌ 提示"请输入正确的手机号码"

邮箱验证：
- 输入：user@example.com → ✅ 通过验证  
- 输入：test.email+tag@domain.co.uk → ✅ 通过验证
- 输入：invalid-email → ❌ 提示"请输入正确的邮箱地址"
- 输入：user@ → ❌ 提示"请输入正确的邮箱地址"
```

### 3. API接口测试

#### 3.1 公司列表API测试
```
API端点：/core/org/om/company/list/roles
方法：GET
期望响应：
{
  "status": 200,
  "data": [
    {
      "id": "company_id",
      "value": "公司名称",
      // ... 其他字段
    }
  ]
}
```

#### 3.2 公司认证API测试  
```
API端点：/core/report/sign/authCompany
方法：POST
请求参数：
{
  "companyName": "测试公司名称",
  "applicant": {
    "contact": "13812345678",
    "contactType": "MOBILE"
  }
}

期望响应：
{
  "status": 200,
  "data": "https://auth.qiyuesuo.cn/?ticket=xxx&channel=OPEN_V2"
}
```

#### 3.3 用户信息API测试
```
API端点：/ess/user/info  
方法：GET
期望响应：
{
  "status": 200,
  "data": {
    "mobile": "13812345678",
    "email": "user@example.com",
    "mailbox": "user@example.com"
    // ... 其他字段
  }
}
```

### 4. 业务流程测试

#### 4.1 完整认证流程测试
```
步骤1：填写基本信息
1. 选择公司（可选）
2. 填写/编辑组织机构名称
3. 选择联系方式类型
4. 输入联系方式
5. 点击确定按钮

期望结果：
✅ 表单验证通过
✅ API调用成功（非400/500错误）
✅ 跳转到契约锁认证页面

步骤2：第三方认证
1. 在契约锁平台完成认证
2. 认证成功后返回系统

期望结果：
✅ 显示认证成功页面
✅ 显示账户ID和印章
```

#### 4.2 边界情况测试
```
场景1：不选择公司
- 直接手动输入组织机构名称
- 验证可以正常提交

场景2：服务器异常
- 模拟API 500错误  
- 验证错误提示友好
- 系统不会崩溃

场景3：用户信息缺失
- 无手机号或邮箱信息
- 验证联系方式输入框为空
- 用户需要手动输入
```

## 🚨 已知问题和注意事项

### 1. 当前阻塞问题
- **后端服务器500错误** - 需要运维/后端团队修复
- **公司列表无法加载** - 依赖服务器恢复
- **认证API可能也受影响** - 需要一并测试

### 2. 待优化项目
- **国际化不完整** - 部分中文硬编码需要添加国际化key
- **错误提示** - 可以更精确地处理不同错误类型
- **用户体验** - 可以添加加载状态和重试机制

### 3. 测试重点关注
- **API参数格式** - 确认后端是否支持新的参数结构
- **邮箱验证规则** - 确认新添加的邮箱正则表达式工作正常
- **权限边界** - 测试没有公司权限的用户能否正常使用

## 📊 测试检查清单

### 环境检查
- [ ] 开发环境可正常访问
- [ ] 用户登录状态正常
- [ ] 浏览器控制台无JavaScript错误
- [ ] 网络连接正常

### 功能测试
- [ ] 页面渲染正常
- [ ] 公司下拉列表有数据
- [ ] 组织机构名称可编辑
- [ ] 联系方式类型切换正常
- [ ] 手机号验证工作正常
- [ ] 邮箱验证工作正常
- [ ] 用户信息自动填充
- [ ] 表单提交无验证阻塞
- [ ] API调用返回200状态
- [ ] 成功跳转契约锁平台

### API测试
- [ ] `/core/org/om/company/list/roles` 返回正常
- [ ] `/core/report/sign/authCompany` 接受新参数格式
- [ ] `/ess/user/info` 返回用户联系信息
- [ ] 认证成功后正确处理回调

## 🔄 下次继续测试的步骤

### 1. 环境准备
```bash
# 1. 确认项目环境
cd /Users/peakom/work/Cloud
npm run serve

# 2. 检查后端服务状态
# 访问任意API端点验证服务器恢复情况
```

### 2. 测试执行
```
1. 打开浏览器开发者工具（F12）
2. 访问公司认证页面
3. 按照测试清单逐项验证
4. 记录任何异常情况或改进建议
```

### 3. 问题反馈格式
```
如发现问题，请提供：
- 具体的操作步骤
- 期望的行为 vs 实际的行为  
- 浏览器控制台的错误信息
- 网络请求的状态码和响应
```

## 💻 代码上下文

### 重要的代码位置
- **主组件**: `/src/views/Sign/CompanyAttest/companyAttest.vue`
- **验证规则**: `/src/utils/rules.js` (新增email规则)
- **API定义**: `/src/api/sign/index.js` (companySign方法)
- **公司API**: `/src/api/Personnel/common.js` (getRoleCompanyList方法)

### 关键方法说明
```javascript
// 1. 获取公司列表
async getOptions() {
  // 调用 /core/org/om/company/list/roles
  // 设置 this.companyOptions
  // 自动选择第一个公司
}

// 2. 联系方式类型切换  
changeContactType(type) {
  // 切换 MOBILE/EMAIL
  // 自动填充用户信息
}

// 3. 表单提交
async submitForm() {
  // 验证表单
  // 构造API参数: {companyName, applicant: {contact, contactType}}
  // 调用 /core/report/sign/authCompany
  // 跳转到契约锁平台
}
```

## ⚠️ 测试注意事项

### 1. 服务器状态检查
测试前必须确认：
- 后端API服务已恢复
- 用户认证系统正常
- 数据库连接正常

### 2. 浏览器兼容性
建议在以下浏览器测试：
- Chrome (主要)
- Safari
- Firefox

### 3. 测试数据准备
需要准备：
- 有效的公司数据
- 测试用户账号（有公司权限）
- 有效的手机号和邮箱地址

## 📞 API端点状态检查

在开始测试前，建议先检查这些关键API的健康状态：

### 检查方法
```bash
# 可以用curl或Postman检查API状态
# (需要替换为实际的认证token)

# 1. 检查公司列表API
GET /core/org/om/company/list/roles

# 2. 检查用户信息API  
GET /ess/user/info

# 3. 检查认证API（需要有效参数）
POST /core/report/sign/authCompany
```

## 🎯 测试成功标准

### 完整功能验证通过标准
- ✅ 页面正常加载，无JavaScript错误
- ✅ 公司下拉列表显示数据
- ✅ 表单验证工作正常（必填项检查、格式验证）
- ✅ 组织机构名称可以编辑
- ✅ 联系方式类型切换流畅
- ✅ 用户信息自动填充正确
- ✅ 表单提交成功，无400/500错误
- ✅ 成功跳转到契约锁认证平台
- ✅ 契约锁认证完成后能正确返回

### 回归测试标准
- ✅ 个人认证功能未受影响
- ✅ 其他系统功能正常
- ✅ 用户权限系统正常工作

## 🐛 已知问题和解决方案

### 1. 当前阻塞问题
**问题**: 后端API全部返回500错误
**影响**: 无法测试完整功能
**解决方案**: 等待运维修复服务器

### 2. 已修复的问题
**问题**: 邮箱验证规则缺失
**解决方案**: 在rules.js中添加email验证规则

**问题**: Loading状态干扰用户输入  
**解决方案**: 移除不必要的loading属性

**问题**: 公司选择过于严格
**解决方案**: 移除必填验证，支持手动输入

## 📋 下次测试的对话开始方式

当需要继续测试时，可以这样开始对话：

```
"现在后端服务器已经恢复了，我们继续测试公司认证系统的修改。
我刚才遇到了[具体问题描述]，请根据测试指南文档帮我分析和解决。"
```

或者：

```  
"请根据公司认证系统测试指南文档，帮我验证修改后的功能是否正常工作。
目前的测试情况是：[描述测试结果]"
```

## 📝 修改历史记录

### 版本信息
- **修改日期**: 2025-08-29
- **修改人**: Claude Assistant  
- **Git分支**: dev-peak-20250825
- **主要变更**: 公司认证流程简化和优化

### 关键决策记录
1. **为什么移除法人信息字段？** - 简化认证流程，减少用户输入负担
2. **为什么支持邮箱认证？** - 提供更多联系方式选择，提升用户体验
3. **为什么移除公司必填验证？** - 增加系统使用灵活性，支持更多业务场景
4. **为什么保留权限API？** - 平衡安全性和可用性

---

**文档版本**: v1.0  
**文档状态**: 待测试验证  
**下次更新**: 测试完成后  
**相关文档**: 公司认证系统重构技术文档.md