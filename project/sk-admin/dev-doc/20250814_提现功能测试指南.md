# 微信提现功能测试指南

## 部署步骤

### 1. 上传云函数
将以下云函数上传到云开发环境：
- `m_createWithdrawRequest` - 创建提现申请
- `m_getWithdrawConfig` - 获取提现配置
- `m_getWithdrawRecords` - 获取提现记录
- `m_processWithdraw` - 处理提现申请

### 2. 初始化数据库
按照 `数据库初始化.md` 文档创建数据库集合和配置

### 3. 编译上传小程序
使用微信开发者工具编译并上传小程序代码

## 测试流程

### 1. 基础功能测试

#### 首页提现入口测试
- 登录普通用户账号
- 确认首页显示提现按钮（需要有待结算金额）
- 点击"立即提现"按钮跳转到提现页面

#### 提现申请页面测试
- 验证余额显示正确
- 测试金额输入和手续费计算
- 测试快速选择金额按钮
- 测试表单验证（空金额、超限金额等）
- 提交提现申请

#### 提现记录页面测试
- 查看提现记录列表
- 测试状态筛选功能
- 测试下拉刷新和上拉加载

### 2. 数据验证测试

#### 验证数据库记录
```javascript
// 在云开发控制台数据库中验证
db.collection('withdrawRequests').get()
```

检查以下字段：
- 提现金额计算正确
- 手续费计算正确  
- 用户信息正确
- 时间记录正确

### 3. 权限测试

#### 用户权限测试
- 测试未登录用户无法访问提现页面
- 测试普通用户可以创建提现申请
- 测试管理员不显示提现按钮（显示结算按钮）

#### 管理员功能测试
- 使用管理员账号登录
- 测试审核提现申请功能
- 验证审核通过/拒绝的状态更新

### 4. 边界条件测试

#### 金额限制测试
```javascript
// 测试用例
const testCases = [
  { amount: 0, expected: '请输入提现金额' },
  { amount: 0.5, expected: '最小提现金额为1元' },
  { amount: 10000, expected: '最大提现金额为5000元' },
  { amount: 999999, expected: '提现金额超过可用余额' }
];
```

#### 频率限制测试
- 测试同一天内多次提现申请
- 验证达到每日限制后的提示

### 5. 错误处理测试

#### 网络异常测试
- 断网状态下操作
- 服务器异常响应处理

#### 数据异常测试
- 余额不足时提现
- 重复提交申请

## 注意事项

### 1. 微信支付配置
当前代码中的微信转账功能为示例代码，实际使用需要：
- 配置真实的商户号和证书
- 开通企业付款权限
- 修改 `m_processWithdraw` 中的转账逻辑

### 2. 测试环境
- 使用测试号进行开发测试
- 不要在生产环境直接测试转账功能
- 建议先模拟转账成功/失败状态

### 3. 安全考虑
- 验证所有用户输入
- 检查权限控制
- 防止重复提交
- 记录操作日志

## 常见问题排查

### 1. 提现按钮不显示
- 检查用户登录状态
- 确认 `remainDistributableAmount > 0`
- 验证用户不是管理员

### 2. 云函数调用失败
- 检查云函数部署状态
- 验证环境ID配置
- 查看云函数日志

### 3. 数据库权限错误
- 检查集合权限设置
- 确认用户身份验证

### 4. 页面路由错误
- 确认 app.json 中已添加新页面
- 检查页面路径正确性

## 生产部署检查清单

- [ ] 云函数全部部署成功
- [ ] 数据库集合和权限配置正确  
- [ ] 微信支付参数配置完成
- [ ] 提现规则和限额设置合理
- [ ] 错误处理和日志记录完善
- [ ] 用户体验和界面测试通过
- [ ] 安全性验证完成
- [ ] 管理员审核流程测试通过