# 提现功能数据库初始化

## 1. 创建数据库集合

在云开发控制台创建以下集合：

### withdrawRequests (提现申请集合)
```json
{
  "id": "WD1641234567890001",
  "userId": "用户openid", 
  "amount": 10000,
  "fee": 60,
  "realAmount": 9940,
  "status": "pending",
  "applyTime": "2025-01-04T10:00:00.000Z",
  "processTime": null,
  "completeTime": null,
  "accountType": "wechat",
  "accountInfo": {
    "openid": "用户openid",
    "nickname": "用户昵称"
  },
  "adminId": null,
  "wechatOrderNo": null,
  "failReason": null,
  "remark": null,
  "createTime": "2025-01-04T10:00:00.000Z",
  "updateTime": "2025-01-04T10:00:00.000Z"
}
```

### withdrawConfig (提现配置集合)
```json
{
  "_id": "default",
  "minAmount": 1,
  "maxAmount": 5000,
  "feeRate": 0.006,
  "dailyLimit": 3,
  "enabled": true
}
```

## 2. 设置集合权限

### withdrawRequests 权限设置
- 读权限：`auth.uid == doc.userId || (auth.uid != null && doc._openid != auth.uid)`
- 写权限：`auth.uid != null`

### withdrawConfig 权限设置  
- 读权限：`auth.uid != null`
- 写权限：`auth.uid != null`

## 3. 创建索引

### withdrawRequests 索引
- userId (单字段索引)
- status (单字段索引)
- applyTime (单字段索引，降序)
- userId + status (复合索引)
- userId + applyTime (复合索引)

## 4. 云函数权限配置

确保以下云函数有数据库访问权限：
- m_createWithdrawRequest
- m_getWithdrawConfig
- m_getWithdrawRecords
- m_processWithdraw

## 5. 微信支付配置

如需要实际转账功能，需要配置：
- 微信商户号
- API密钥  
- 商户证书
- 开通企业付款权限

**注意**: 示例代码中的微信转账部分需要根据实际的微信支付配置进行修改。