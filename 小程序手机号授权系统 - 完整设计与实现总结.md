小程序手机号授权系统 - 完整设计与实现总结

  一、业务背景和需求

  用户场景：用户在小程序中点击购买商品 → 如果未授权手机号 → 弹出手机号授权提示 → 用户授权手机号 → 后端解密获取用户信息 → 自动注册/登录用户

  核心需求：
  - 支持微信手机号授权作为主要登录方式
  - 支持现有的openId登录方式
  - 手机号和openId可绑定
  - 首次登录自动注册用户

---
  二、系统架构设计

  整体流程

  小程序端                          后端服务                    数据库
  ┌─────────────┐               ┌─────────────┐           ┌─────────────┐
  │ getPhone    │               │ Decrypt     │           │   Users     │
  │ Number      │──加密数据──→  │ Wechat Data │──查询──→  │   Table     │
  │ Event       │               │             │           │             │
  └─────────────┘               │ Create/     │──创建──→  │ 存储用户    │
                                │ Update User │           │ phone,      │
                                │             │           │ openId等    │
                                │ Return JWT  │           └─────────────┘
                                │ Token       │
                                └─────────────┘

  核心模块关系

  User Entity (数据模型)
      ↓
  UsersService (数据库操作 - TypeORM)
      ↓
  AuthService (业务逻辑 - 解密、登录、注册)
      ↓
  AuthController (API端点)

---
  三、数据库设计

  Users表结构

  CREATE TABLE users (
    -- 认证字段
    id INT PRIMARY KEY,
    phone VARCHAR(20) UNIQUE,        -- 主要登录方式
    open_id VARCHAR(100) UNIQUE,     -- 微信openId
    username VARCHAR(100) UNIQUE,    -- 用户名（可选）
    email VARCHAR(100) UNIQUE,       -- 邮箱（可选）
    password VARCHAR(255),           -- 密码哈希（仅用户名登录）

    -- 用户信息
    nickname VARCHAR(100),           -- 昵称
    avatar_url VARCHAR(500),         -- 头像
    gender ENUM('male','female','unknown'),
    province/city/country VARCHAR,   -- 地区信息
    
    -- 授权状态
    is_phone_authorized BOOLEAN,     -- 是否已授权手机号
    is_profile_authorized BOOLEAN,   -- 是否已授权昵称头像
    
    -- 账户管理
    status ENUM('active','banned','deleted'),
    registration_source ENUM('wechat_mini_program','web','admin'),
    
    -- 登录跟踪
    last_login_at TIMESTAMP,
    last_login_ip VARCHAR(50),
    login_count INT,
    
    -- 时间戳
    created_at/updated_at TIMESTAMP
  )

  关键设计决策

| 字段                      | 设计理由                   |
| ------------------------- | -------------------------- |
| phone/openId 都唯一       | 支持多账户绑定，避免重复   |
| password 可空             | 手机号登录不需要密码       |
| is_phone_authorized       | 跟踪授权状态，控制功能访问 |
| status 字段               | 软删除，保留历史数据       |
| login_count/last_login_at | 安全审计和用户行为分析     |

---
  四、业务逻辑设计

  4.1 手机号解密流程

  微信加密手机号格式：
  - 小程序通过 <button open-type="getPhoneNumber"> 获取加密数据
  - 获得三个参数：encryptedData, iv, sessionKey（都是base64编码）

  后端解密步骤：
  1. 将base64字符串转换为Buffer
  2. 使用AES-128-CBC解密算法
     - Key: sessionKey
     - IV: iv
     - Data: encryptedData
  3. 移除PKCS#7填充
  4. 解析JSON得到手机号

  为什么选AES-128-CBC：
  - 微信官方标准加密方式
  - 对称加密，快速高效
  - 安全性足够

  4.2 用户创建/更新策略

  // 情况1: 新用户首次通过手机号登录
  手机号 → 数据库查询 → 不存在 → 创建新用户
  新用户的openId = null, is_phone_authorized = true

  // 情况2: 已有openId用户，首次授权手机号
  openId → 数据库查询 → 存在 → 绑定手机号
  更新: phone字段, is_phone_authorized = true

  // 情况3: 多个openId对应同一手机号（切换设备）
  手机号 → 数据库查询 → 存在 → 更新openId
  同一用户在不同设备登录

  4.3 两种登录方式

| 方式       | API                             | 参数                                   | 使用场景                 |
| ---------- | ------------------------------- | -------------------------------------- | ------------------------ |
| 手机号登录 | POST /auth/wechat/phone-login   | openId, encryptedPhone, iv, sessionKey | 用户授权手机号后         |
| openId登录 | POST /auth/wechat/open-id-login | openId, nickName, avatarUrl等          | 首次登录，仅获取基本信息 |

---
  五、代码实现要点

  5.1 Service层设计（UsersService）

  核心方法：
  // 查询方法 - 支持多种登录方式
  findByPhone(phone)           // 手机号查询
  findByOpenId(openId)         // openId查询
  findByUsername(username)     // 用户名查询

  // 创建/更新方法
  createOrUpdateByPhone(phone, openId, userData)  // 创建或更新
  bindPhoneToOpenId(openId, phone)              // 绑定手机号

  // 管理方法
  updateLastLogin(userId, ip)                    // 更新登录信息
  remove(id)                                     // 软删除

  TypeORM仓储模式的优势：
  - 自动SQL生成，避免手工SQL错误
  - 类型安全，编译时检查
  - 易于测试和维护
  - 支持复杂查询和事务

  5.2 Auth层设计（AuthService）

  核心方法：
  // 解密方法
  decryptWechatData(encryptedData, iv, sessionKey): object

  // 登录方法
  wechatPhoneLogin(openId, encryptedPhone, iv, sessionKey)
  wechatOpenIdLogin(openId, userData)

  // 内部调用UsersService进行数据库操作
  // 返回JWT token给前端

  关键安全措施：
  - 使用bcryptjs哈希密码（传统登录）
  - AES-128-CBC解密验证
  - 异常捕获和日志记录
  - 不返回敏感字段（password）

  5.3 Controller层设计（AuthController）

  @Post('wechat/phone-login')       // 手机号登录
  @Post('wechat/open-id-login')     // openId登录

  API响应格式：
  {
    "access_token": "eyJhbGc...",
    "user": {
      "id": 1,
      "phone": "13800138000",
      "openId": "oABC123XYZ...",
      "nickname": "用户昵称",
      "avatarUrl": "https://...",
      "isPhoneAuthorized": true,
      "lastLoginAt": "2025-10-29T10:30:00Z"
    }
  }

---
  六、关键设计决策解释

  6.1 为什么phone是主要登录方式？

  业务考虑：
  ✓ 手机号是用户在微信生态中的唯一身份证
  ✓ 手机号授权更直接，用户体验好
  ✓ 手机号可用于后续通知（短信、客服等）
  ✓ 支持跨设备登录（手机号唯一，openId多个）

  技术考虑：
  ✓ 手机号唯一，避免多设备数据混乱
  ✓ openId在换设备时会改变，不稳定

  6.2 为什么需要软删除？

  原因：
  ✓ 保留用户数据和交易历史
  ✓ 便于审计和追踪
  ✓ 可恢复已删除账户
  ✓ 符合法律合规要求

  实现：
  - status = 'deleted' 而非真删除
  - 查询时自动过滤 status != 'deleted'

  6.3 为什么分离创建和更新逻辑？

  场景：
  1. 新用户：创建user记录，设置phone和openId
  2. 老用户：仅更新phone或openId
  3. 跨设备：同一hand机号，不同openId

  解决方案：
  createOrUpdateByPhone() 方法内部判断：
  - 查询phone是否存在
  - 存在：update，不存在：create
  - 自动处理所有场景

---
  七、与现有系统的集成

  7.1 数据库集成

  变更：
  - 创建User Entity (TypeORM)
  - 创建users表迁移脚本
  - 注册User Entity到database.config.ts

  7.2 模块集成

  UsersModule
    ↓ TypeOrmModule.forFeature([User])
    ↓ 提供UsersService

  AuthModule
    ↓ imports: [UsersModule]
    ↓ 使用UsersService

  7.3 现有功能兼容性

  保留：
  ✓ 原有的 POST /auth/login (用户名密码)
  ✓ 原有的 POST /auth/register (用户名注册)

  新增：
  ✓ POST /auth/wechat/phone-login (手机号授权)
  ✓ POST /auth/wechat/open-id-login (openId登录)

  没有冲突！支持多种登录方式并存

---
  八、安全性考虑

| 风险点         | 防护措施                                    |
| -------------- | ------------------------------------------- |
| 手机号泄露     | 数据库加密存储，API不返回未授权用户的手机号 |
| 会话密钥被截获 | 仅在后端解密，HTTPS传输                     |
| Token伪造      | JWT签名验证，过期时间设置                   |
| 重复授权       | unique constraint在数据库层                 |
| 暴力破解       | 解密失败记录日志，可配置限流                |

---
  九、未来扩展点

  1. 手机号换绑
     - 验证码确认
     - 旧手机号解绑流程

  2. 账户合并
     - 多个openId合并
     - 数据迁移

  3. 安全审计
     - 登录地点追踪
     - 异常登录告警

  4. 用户行为分析
     - 登录频次统计
     - 设备信息记录

  5. 集成第三方认证
     - 支付宝登录
     - QQ登录等

---
  十、总结表

| 维度     | 设计内容                            |
| -------- | ----------------------------------- |
| 数据模型 | User Entity + 8张字段 + 6个索引     |
| 服务层   | UsersService (8个方法)              |
| 业务层   | AuthService (4个方法 + 解密逻辑)    |
| API      | 2个新endpoint + 改进现有2个endpoint |
| 数据库   | 1个迁移脚本                         |
| DTO      | 1个手机号登录DTO                    |
| 安全     | AES-128-CBC + bcryptjs + JWT        |
| 支持场景 | 新用户注册、老用户绑定、跨设备登录  |

---
  完成度统计

  ✅ 已完成 (6项)：
  1. User Entity创建
  2. 数据库迁移脚本
  3. UsersService重构
  4. AuthService扩展
  5. AuthController更新
  6. WeChat手机号解密API

  ⏳ 待进行 (2项)：
  7. 小程序授权组件
  8. 端到端测试